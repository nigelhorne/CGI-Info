
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>

/* --------------------------------------------------
   CSS Variables (Light Mode Default)
-------------------------------------------------- */

:root {
    --bg: #ffffff;
    --text: #000000;
    --table-header: #333;
    --table-header-text: #ffffff;

    --survived-1: #f8d7da;
    --survived-2: #f5b7b1;
    --survived-3: #ec7063;

    --killed: #d4edda;
    --border: #cccccc;
}

/* --------------------------------------------------
   Dark Mode Overrides
-------------------------------------------------- */

html[data-theme='dark'] {
    --bg: #1e1e1e;
    --text: #dddddd;
    --table-header: #222;
    --table-header-text: #ffffff;

    --survived-1: #5c2b2e;
    --survived-2: #7b2c2f;
    --survived-3: #a93226;

    --killed: #1e4620;
    --border: #555;
}

/* --------------------------------------------------
   Global Styles
-------------------------------------------------- */

body {
	font-family: sans-serif;
	background: var(--bg);
	color: var(--text);
}

table {
    border-collapse: collapse;
    width: 100%;
}

th {
    background: var(--table-header);
    color: var(--table-header-text);
}

.survived-1 { background-color: var(--survived-1); }
.survived-2 { background-color: var(--survived-2); }
.survived-3 { background-color: var(--survived-3); }

.killed { background-color: var(--killed); }

.legend-box {
    display: inline-block;
    width: 16px;
    height: 16px;
    margin: 0 6px 0 20px;
    vertical-align: middle;
    border: 1px solid var(--border);
}

/* White box for non-mutated lines */
.legend-box.none {
	background-color: var(--bg);
}

pre { line-height: 1.4; }

pre > details {
    margin: 0.2em 0;
}

pre > details:first-child {
    margin-top: 0;
}

pre > details:last-child {
    margin-bottom: 0;
}

pre details,
pre summary,
pre ul,
pre li {
    white-space: normal;
    margin: 0;
    padding: 0;
    line-height: 1.2;
}

.nav { margin-bottom: 1em; }

.toggle {
    float: right;
    cursor: pointer;
    padding: 6px 10px;
    border: 1px solid var(--border);
    border-radius: 4px;
}

/* Tooltip container */
.tooltip {
	position: relative;
	cursor: help;
}

/* Tooltip bubble */
.tooltip:hover::after {
    content: attr(data-tooltip);
    position: absolute;
    left: 0;
    top: 100%;
    background: var(--table-header);
    color: var(--table-header-text);
    padding: 6px 10px;
    white-space: normal;
    max-width: 300px;
    min-width: 30ch;
    font-size: 12px;
    border-radius: 6px;
    z-index: 1000;
    margin-left: 10ch;   /* move tooltip ~10 characters to the right */
}

.mutant-details {
	margin-left: 2em;
	font-size: 0.9em;
}

/* Indent the list of mutations that displays when expanding by 8 characters */
pre details.mutant-details ul {
	padding-left: 8ch;
	margin: 0.2em 0;
}

.mutant-details summary {
	cursor: pointer;
	font-weight: bold;
}

</style>
</head>
<body>
<button class="toggle" onclick="toggleTheme()">ðŸŒ™ Toggle Theme</button>
<h1>lib/CGI/Info.pm</h1>
<div class="nav"><a href="../../../index.html">Index</a></div>
		<div class="legend">
			<span class="legend-box survived-1"></span> Survived (tests missed this)
			<span class="legend-box killed"></span> Killed (tests detected this)
			<span class="legend-box none"></span> No mutation
		</div>
	<pre>
<span class="">    1: package CGI::Info;
</span><span class="">    2: 
</span><span class="">    3: # TODO: remove the expect argument
</span><span class="">    4: # TODO:	look into params::check or params::validate
</span><span class="">    5: 
</span><span class="">    6: use warnings;
</span><span class="">    7: use strict;
</span><span class="">    8: 
</span><span class="">    9: use boolean;
</span><span class="">   10: use Carp;
</span><span class="">   11: use Object::Configure 0.19;
</span><span class="">   12: use File::Spec;
</span><span class="">   13: use Log::Abstraction 0.10;
</span><span class="">   14: use Params::Get 0.13;
</span><span class="">   15: use Params::Validate::Strict 0.21;
</span><span class="">   16: use Net::CIDR;
</span><span class="">   17: use Return::Set;
</span><span class="">   18: use Scalar::Util;
</span><span class="">   19: use Socket;	# For AF_INET
</span><span class="">   20: use 5.008;
</span><span class="">   21: # use Cwd;
</span><span class="">   22: # use JSON::Parse;
</span><span class="">   23: use List::Util ();	# Can go when expect goes
</span><span class="">   24: # use Sub::Private;
</span><span class="">   25: use Sys::Path;
</span><span class="">   26: 
</span><span class="">   27: use namespace::clean;
</span><span class="">   28: 
</span><span class="">   29: sub _sanitise_input($);
</span><span class="">   30: 
</span><span class="">   31: =head1 NAME
</span><span class="">   32: 
</span><span class="">   33: CGI::Info - Information about the CGI environment
</span><span class="">   34: 
</span><span class="">   35: =head1 VERSION
</span><span class="">   36: 
</span><span class="">   37: Version 1.11
</span><span class="">   38: 
</span><span class="">   39: =cut
</span><span class="">   40: 
</span><span class="">   41: our $VERSION = &#39;1.11&#39;;
</span><span class="">   42: 
</span><span class="">   43: =head1 SYNOPSIS
</span><span class="">   44: 
</span><span class="">   45: The C&lt;CGI::Info&gt; module is a Perl library designed to provide information about the environment in which a CGI script operates.
</span><span class="">   46: It aims to eliminate hard-coded script details,
</span><span class="">   47: enhancing code readability and portability.
</span><span class="">   48: Additionally, it offers a simple web application firewall to add a layer of security.
</span><span class="">   49: 
</span><span class="">   50: All too often,
</span><span class="">   51: Perl programs have information such as the script&#39;s name
</span><span class="">   52: hard-coded into their source.
</span><span class="">   53: Generally speaking,
</span><span class="">   54: hard-coding is a bad style since it can make programs difficult to read and reduces readability and portability.
</span><span class="">   55: CGI::Info attempts to remove that.
</span><span class="">   56: 
</span><span class="">   57: Furthermore, to aid script debugging, CGI::Info attempts to do sensible
</span><span class="">   58: things when you&#39;re not running the program in a CGI environment.
</span><span class="">   59: 
</span><span class="">   60: Whilst you shouldn&#39;t rely on it alone to provide security to your website,
</span><span class="">   61: it is another layer and every little helps.
</span><span class="">   62: 
</span><span class="">   63:     use CGI::Info;
</span><span class="">   64: 
</span><span class="">   65:     my $info = CGI::Info-&gt;new(allow =&gt; { id =&gt; qr/^\d+$/ });
</span><span class="">   66:     my $params = $info-&gt;params();
</span><span class="">   67: 
</span><span class="">   68:     if($info-&gt;is_mobile()) {
</span><span class="">   69:         print &quot;Mobile view\n&quot;;
</span><span class="">   70:     } else {
</span><span class="">   71:         print &quot;Desktop view\n&quot;;
</span><span class="">   72:     }
</span><span class="">   73: 
</span><span class="">   74:     my $id = $info-&gt;param(&#39;id&#39;);	# Validated against allow schema
</span><span class="">   75: 
</span><span class="">   76: =head1 SUBROUTINES/METHODS
</span><span class="">   77: 
</span><span class="">   78: =head2 new
</span><span class="">   79: 
</span><span class="">   80: Creates a CGI::Info object.
</span><span class="">   81: 
</span><span class="">   82: It takes four optional arguments: allow, logger, expect and upload_dir,
</span><span class="">   83: which are documented in the params() method.
</span><span class="">   84: 
</span><span class="">   85: It takes other optional parameters:
</span><span class="">   86: 
</span><span class="">   87: =over 4
</span><span class="">   88: 
</span><span class="">   89: =item * C&lt;auto_load&gt;
</span><span class="">   90: 
</span><span class="">   91: Enable/disable the AUTOLOAD feature.
</span><span class="">   92: The default is to have it enabled.
</span><span class="">   93: 
</span><span class="">   94: =item * C&lt;config_dirs&gt;
</span><span class="">   95: 
</span><span class="">   96: Where to look for C&lt;config_file&gt;
</span><span class="">   97: 
</span><span class="">   98: =item * C&lt;config_file&gt;
</span><span class="">   99: 
</span><span class="">  100: Points to a configuration file which contains the parameters to C&lt;new()&gt;.
</span><span class="">  101: The file can be in any common format,
</span><span class="">  102: including C&lt;YAML&gt;, C&lt;XML&gt;, and C&lt;INI&gt;.
</span><span class="">  103: This allows the parameters to be set at run time.
</span><span class="">  104: 
</span><span class="">  105: On non-Windows system,
</span><span class="">  106: the class can be configured using environment variables starting with &quot;CGI::Info::&quot;.
</span><span class="">  107: For example:
</span><span class="">  108: 
</span><span class="">  109:   export CGI::Info::max_upload_size=65536
</span><span class="">  110: 
</span><span class="">  111: It doesn&#39;t work on Windows because of the case-insensitive nature of that system.
</span><span class="">  112: 
</span><span class="">  113: If the configuration file has a section called C&lt;CGI::Info&gt;,
</span><span class="">  114: only that section,
</span><span class="">  115: and the C&lt;global&gt; section,
</span><span class="">  116: if any exists,
</span><span class="">  117: is used.
</span><span class="">  118: 
</span><span class="">  119: =item * C&lt;syslog&gt;
</span><span class="">  120: 
</span><span class="">  121: Takes an optional parameter syslog, to log messages to
</span><span class="">  122: L&lt;Sys::Syslog&gt;.
</span><span class="">  123: It can be a boolean to enable/disable logging to syslog, or a reference
</span><span class="">  124: to a hash to be given to Sys::Syslog::setlogsock.
</span><span class="">  125: 
</span><span class="">  126: =item * C&lt;cache&gt;
</span><span class="">  127: 
</span><span class="">  128: An object that is used to cache IP lookups.
</span><span class="">  129: This cache object is an object that understands get() and set() messages,
</span><span class="">  130: such as a L&lt;CHI&gt; object.
</span><span class="">  131: 
</span><span class="">  132: =item * C&lt;max_upload_size&gt;
</span><span class="">  133: 
</span><span class="">  134: The maximum file size you can upload (-1 for no limit), the default is 512MB.
</span><span class="">  135: 
</span><span class="">  136: =back
</span><span class="">  137: 
</span><span class="">  138: The class can be configured at runtime using environments and configuration files,
</span><span class="">  139: for example,
</span><span class="">  140: setting C&lt;$ENV{&#39;CGI__INFO__carp_on_warn&#39;}&gt; causes warnings to use L&lt;Carp&gt;.
</span><span class="">  141: For more information about configuring object constructors at runtime,
</span><span class="">  142: see L&lt;Object::Configure&gt;.
</span><span class="">  143: 
</span><span class="">  144: =cut
</span><span class="">  145: 
</span><span class="">  146: our $stdin_data;	# Class variable storing STDIN in case the class
</span><span class="">  147: 			# is instantiated more than once
</span><span class="">  148: 
</span><span class="">  149: sub new
</span><span class="">  150: {
</span><span class="">  151: 	my $class = shift;
</span><span class="">  152: 
</span><span class="">  153: 	# Handle hash or hashref arguments
</span><span class="">  154: 	my $params = Params::Get::get_params(undef, @_) || {};
</span><span class="">  155: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  156: 	if(!defined($class)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_156: Invert condition</b></li>
</ul></details>
<span class="survived-1 tooltip" data-tooltip="Boundary mutation survived. Add tests around edge values (e.g. min, max, off-by-one).">  157: 		if((scalar keys %{$params}) &gt; 0) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 5, Killed: 4, Survived: 1)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_157: Numeric boundary flip > to <</b></li>
<li><b>NUM_BOUNDARY_157: Numeric boundary flip > to >=</b></li>
<li><b>NUM_BOUNDARY_157: Numeric boundary flip > to <=</b></li>
<li><b>NUM_BOUNDARY_157: Numeric boundary flip > to ==</b></li>
<li><b>COND_INV_157: Invert condition</b></li>
</ul></details>
<span class="">  158: 			# Using CGI::Info:new(), not CGI::Info-&gt;new()
</span><span class="">  159: 			croak(__PACKAGE__, &#39; use -&gt;new() not ::new() to instantiate&#39;);
</span><span class="">  160: 		}
</span><span class="">  161: 
</span><span class="">  162: 		# FIXME: this only works when no arguments are given
</span><span class="">  163: 		$class = __PACKAGE__;
</span><span class="">  164: 	} elsif(Scalar::Util::blessed($class)) {
</span><span class="">  165: 		# If $class is an object, clone it with new arguments
</span><span class="">  166: 		return bless { %{$class}, %{$params} }, ref($class);
</span><span class="">  167: 	}
</span><span class="">  168: 
</span><span class="">  169: 	# Load the configuration from a config file, if provided
</span><span class="">  170: 	$params = Object::Configure::configure($class, $params);
</span><span class="">  171: 
</span><span class="">  172: 	# Validate logger object has required methods
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  173: 	if(defined $params-&gt;{&#39;logger&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_173: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  174: 		unless(Scalar::Util::blessed($params-&gt;{&#39;logger&#39;}) &amp;&amp; $params-&gt;{&#39;logger&#39;}-&gt;can(&#39;warn&#39;) &amp;&amp; $params-&gt;{&#39;logger&#39;}-&gt;can(&#39;info&#39;) &amp;&amp; $params-&gt;{&#39;logger&#39;}-&gt;can(&#39;error&#39;)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_174: Invert condition</b></li>
</ul></details>
<span class="">  175: 			Carp::croak(&quot;Logger must be an object with info() and error() methods&quot;);
</span><span class="">  176: 		}
</span><span class="">  177: 	}
</span><span class="">  178: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  179: 	if(defined($params-&gt;{&#39;expect&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_179: Invert condition</b></li>
</ul></details>
<span class="">  180: 		# if(ref($params-&gt;{expect}) ne &#39;ARRAY&#39;) {
</span><span class="">  181: 			# Carp::croak(__PACKAGE__, &#39;: expect must be a reference to an array&#39;);
</span><span class="">  182: 		# }
</span><span class="">  183: 		# # warn __PACKAGE__, &#39;: expect is deprecated, use allow instead&#39;;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  184: 		if(my $logger = $params-&gt;{&#39;logger&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_184: Invert condition</b></li>
</ul></details>
<span class="">  185: 			$logger-&gt;error(&quot;$class: expect has been deprecated, use allow instead&quot;);
</span><span class="">  186: 		}
</span><span class="">  187: 		Carp::croak(&quot;$class: expect has been deprecated, use allow instead&quot;);
</span><span class="">  188: 	}
</span><span class="">  189: 
</span><span class="">  190: 	# Return the blessed object
</span><span class="">  191: 	return bless {
</span><span class="">  192: 		max_upload_size =&gt; 512 * 1024,
</span><span class="">  193: 		allow =&gt; undef,
</span><span class="">  194: 		upload_dir =&gt; undef,
</span><span class="">  195: 		%{$params}	# Overwrite defaults with given arguments
</span><span class="">  196: 	}, $class;
</span><span class="">  197: }
</span><span class="">  198: 
</span><span class="">  199: =head2 script_name
</span><span class="">  200: 
</span><span class="">  201: Retrieves the name of the executing CGI script.
</span><span class="">  202: This is useful for POSTing,
</span><span class="">  203: thus avoiding hard-coded paths into forms.
</span><span class="">  204: 
</span><span class="">  205: 	use CGI::Info;
</span><span class="">  206: 
</span><span class="">  207: 	my $info = CGI::Info-&gt;new();
</span><span class="">  208: 	my $script_name = $info-&gt;script_name();
</span><span class="">  209: 	# ...
</span><span class="">  210: 	print &quot;&lt;form method=\&quot;POST\&quot; action=$script_name name=\&quot;my_form\&quot;&gt;\n&quot;;
</span><span class="">  211: 
</span><span class="">  212: =head3 API SPECIFICATION
</span><span class="">  213: 
</span><span class="">  214: =head4 INPUT
</span><span class="">  215: 
</span><span class="">  216: None.
</span><span class="">  217: 
</span><span class="">  218: =head4 OUTPUT
</span><span class="">  219: 
</span><span class="">  220:   {
</span><span class="">  221:     type =&gt; &#39;string&#39;,
</span><span class="">  222:     &#39;min&#39; =&gt; 1,
</span><span class="">  223:     &#39;nomatch&#39; =&gt; qr/^[\/\\]/	# Does not return absolute path
</span><span class="">  224:   }
</span><span class="">  225: 
</span><span class="">  226: =cut
</span><span class="">  227: 
</span><span class="">  228: sub script_name
</span><span class="">  229: {
</span><span class="">  230: 	my $self = shift;
</span><span class="">  231: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  232: 	unless($self-&gt;{script_name}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_232: Invert condition</b></li>
</ul></details>
<span class="">  233: 		$self-&gt;_find_paths();
</span><span class="">  234: 	}
</span><span class="">  235: 	return $self-&gt;{script_name};
</span><span class="">  236: }
</span><span class="">  237: 
</span><span class="">  238: sub _find_paths {
</span><span class="">  239: 	my $self = shift;
</span><span class="">  240: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  241: 	if(!UNIVERSAL::isa((caller)[0], __PACKAGE__)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_241: Invert condition</b></li>
</ul></details>
<span class="">  242: 		Carp::croak(&#39;Illegal Operation: This method can only be called by a subclass or ourself&#39;);
</span><span class="">  243: 	}
</span><span class="">  244: 
</span><span class="">  245: 	$self-&gt;_trace(__PACKAGE__ . &#39;: entering _find_paths&#39;);
</span><span class="">  246: 
</span><span class="">  247: 	require File::Basename &amp;&amp; File::Basename-&gt;import() unless File::Basename-&gt;can(&#39;basename&#39;);
</span><span class="">  248: 
</span><span class="">  249: 	# Determine script name
</span><span class="">  250: 	my $script_name = $self-&gt;_get_env(&#39;SCRIPT_NAME&#39;) // $0;
</span><span class="">  251: 	$self-&gt;{script_name} = $self-&gt;_untaint_filename({
</span><span class="">  252: 		filename =&gt; File::Basename::basename($script_name)
</span><span class="">  253: 	});
</span><span class="">  254: 
</span><span class="">  255: 	# Determine script path
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  256: 	if(my $script_path = $self-&gt;_get_env(&#39;SCRIPT_FILENAME&#39;)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_256: Invert condition</b></li>
</ul></details>
<span class="">  257: 		$self-&gt;{script_path} = $script_path;
</span><span class="">  258: 	} elsif($script_name = $self-&gt;_get_env(&#39;SCRIPT_NAME&#39;)) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  259: 		if(my $document_root = $self-&gt;_get_env(&#39;DOCUMENT_ROOT&#39;)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_259: Invert condition</b></li>
</ul></details>
<span class="">  260: 			$script_name = $self-&gt;_get_env(&#39;SCRIPT_NAME&#39;);
</span><span class="">  261: 
</span><span class="">  262: 			# It&#39;s usually the case, e.g. /cgi-bin/foo.pl
</span><span class="">  263: 			$script_name =~ s{^/}{};
</span><span class="">  264: 
</span><span class="">  265: 			$self-&gt;{script_path} = File::Spec-&gt;catfile($document_root, $script_name);
</span><span class="">  266: 		} else {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  267: 			if(File::Spec-&gt;file_name_is_absolute($script_name) &amp;&amp; (-r $script_name)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_267: Invert condition</b></li>
</ul></details>
<span class="">  268: 				# Called from a command line with a full path
</span><span class="">  269: 				$self-&gt;{script_path} = $script_name;
</span><span class="">  270: 			} else {
</span><span class="">  271: 				require Cwd unless Cwd-&gt;can(&#39;abs_path&#39;);
</span><span class="">  272: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  273: 				if($script_name =~ /^\/(.+)/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_273: Invert condition</b></li>
</ul></details>
<span class="">  274: 					# It&#39;s usually the case, e.g. /cgi-bin/foo.pl
</span><span class="">  275: 					$script_name = $1;
</span><span class="">  276: 				}
</span><span class="">  277: 
</span><span class="">  278: 				$self-&gt;{script_path} = File::Spec-&gt;catfile(Cwd::abs_path(), $script_name);
</span><span class="">  279: 			}
</span><span class="">  280: 		}
</span><span class="">  281: 	} elsif(File::Spec-&gt;file_name_is_absolute($0)) {
</span><span class="">  282: 		# Called from a command line with a full path
</span><span class="">  283: 		$self-&gt;{script_path} = $0;
</span><span class="">  284: 	} else {
</span><span class="">  285: 		$self-&gt;{script_path} = File::Spec-&gt;rel2abs($0);
</span><span class="">  286: 	}
</span><span class="">  287: 
</span><span class="">  288: 	# Untaint and finalize script path
</span><span class="">  289: 	$self-&gt;{script_path} = $self-&gt;_untaint_filename({
</span><span class="">  290: 		filename =&gt; $self-&gt;{script_path}
</span><span class="">  291: 	});
</span><span class="">  292: }
</span><span class="">  293: 
</span><span class="">  294: =head2 script_path
</span><span class="">  295: 
</span><span class="">  296: Finds the full path name of the script.
</span><span class="">  297: 
</span><span class="">  298: 	use CGI::Info;
</span><span class="">  299: 
</span><span class="">  300: 	my $info = CGI::Info-&gt;new();
</span><span class="">  301: 	my $fullname = $info-&gt;script_path();
</span><span class="">  302: 	my @statb = stat($fullname);
</span><span class="">  303: 
</span><span class="">  304: 	if(@statb) {
</span><span class="">  305: 		my $mtime = localtime $statb[9];
</span><span class="">  306: 		print &quot;Last-Modified: $mtime\n&quot;;
</span><span class="">  307: 		# TODO: only for HTTP/1.1 connections
</span><span class="">  308: 		# $etag = Digest::MD5::md5_hex($html);
</span><span class="">  309: 		printf &quot;ETag: \&quot;%x\&quot;\n&quot;, $statb[9];
</span><span class="">  310: 	}
</span><span class="">  311: =cut
</span><span class="">  312: 
</span><span class="">  313: sub script_path {
</span><span class="">  314: 	my $self = shift;
</span><span class="">  315: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  316: 	unless($self-&gt;{script_path}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_316: Invert condition</b></li>
</ul></details>
<span class="">  317: 		$self-&gt;_find_paths();
</span><span class="">  318: 	}
</span><span class="">  319: 	return $self-&gt;{script_path};
</span><span class="">  320: }
</span><span class="">  321: 
</span><span class="">  322: =head2 script_dir
</span><span class="">  323: 
</span><span class="">  324: Returns the file system directory containing the script.
</span><span class="">  325: 
</span><span class="">  326: 	use CGI::Info;
</span><span class="">  327: 	use File::Spec;
</span><span class="">  328: 
</span><span class="">  329: 	my $info = CGI::Info-&gt;new();
</span><span class="">  330: 
</span><span class="">  331: 	print &#39;HTML files are normally stored in &#39;, $info-&gt;script_dir(), &#39;/&#39;, File::Spec-&gt;updir(), &quot;\n&quot;;
</span><span class="">  332: 
</span><span class="">  333: 	# or
</span><span class="">  334: 	use lib CGI::Info::script_dir() . &#39;../lib&#39;;
</span><span class="">  335: 
</span><span class="">  336: =cut
</span><span class="">  337: 
</span><span class="">  338: sub script_dir
</span><span class="">  339: {
</span><span class="">  340: 	my $self = shift;
</span><span class="">  341: 
</span><span class="">  342: 	# Ensure $self is an object
</span><span class="">  343: 	$self = __PACKAGE__-&gt;new() unless ref $self;
</span><span class="">  344: 
</span><span class="">  345: 	# Set script path if it is not already defined
</span><span class="">  346: 	$self-&gt;_find_paths() unless $self-&gt;{script_path};
</span><span class="">  347: 
</span><span class="">  348: 	# Extract directory from script path based on OS
</span><span class="">  349: 	# Don&#39;t use File::Spec-&gt;splitpath() since that can leave the trailing slash
</span><span class="">  350: 	my $dir_regex = $^O eq &#39;MSWin32&#39; ? qr{(.+)\\.+?$} : qr{(.+)/.+?$};
</span><span class="">  351: 
</span><span class="">  352: 	return $self-&gt;{script_path} =~ $dir_regex ? $1 : $self-&gt;{script_path};
</span><span class="">  353: }
</span><span class="">  354: 
</span><span class="">  355: =head2 host_name
</span><span class="">  356: 
</span><span class="">  357: Return the host-name of the current web server, according to CGI.
</span><span class="">  358: If the name can&#39;t be determined from the web server, the system&#39;s host-name
</span><span class="">  359: is used as a fall back.
</span><span class="">  360: This may not be the same as the machine that the CGI script is running on,
</span><span class="">  361: some ISPs and other sites run scripts on different machines from those
</span><span class="">  362: delivering static content.
</span><span class="">  363: There is a good chance that this will be domain_name() prepended with either
</span><span class="">  364: &#39;www&#39; or &#39;cgi&#39;.
</span><span class="">  365: 
</span><span class="">  366: 	use CGI::Info;
</span><span class="">  367: 
</span><span class="">  368: 	my $info = CGI::Info-&gt;new();
</span><span class="">  369: 	my $host_name = $info-&gt;host_name();
</span><span class="">  370: 	my $protocol = $info-&gt;protocol();
</span><span class="">  371: 	# ...
</span><span class="">  372: 	print &quot;Thank you for visiting our &lt;A HREF=\&quot;$protocol://$host_name\&quot;&gt;Website!&lt;/A&gt;&quot;;
</span><span class="">  373: 
</span><span class="">  374: =cut
</span><span class="">  375: 
</span><span class="">  376: sub host_name {
</span><span class="">  377: 	my $self = shift;
</span><span class="">  378: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  379: 	unless($self-&gt;{site}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_379: Invert condition</b></li>
</ul></details>
<span class="">  380: 		$self-&gt;_find_site_details();
</span><span class="">  381: 	}
</span><span class="">  382: 
</span><span class="">  383: 	return $self-&gt;{site};
</span><span class="">  384: }
</span><span class="">  385: 
</span><span class="">  386: sub _find_site_details
</span><span class="">  387: {
</span><span class="">  388: 	my $self = shift;
</span><span class="">  389: 
</span><span class="">  390: 	# Log entry to the routine
</span><span class="">  391: 	$self-&gt;_trace(&#39;Entering _find_site_details&#39;);
</span><span class="">  392: 
</span><span class="">  393: 	return if $self-&gt;{site} &amp;&amp; $self-&gt;{cgi_site};
</span><span class="">  394: 
</span><span class="">  395: 	# Determine cgi_site using environment variables or hostname
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  396: 	if (my $host = ($ENV{&#39;HTTP_HOST&#39;} || $ENV{&#39;SERVER_NAME&#39;} || $ENV{&#39;SSL_TLS_SNI&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_396: Invert condition</b></li>
</ul></details>
<span class="">  397: 		# Import necessary module
</span><span class="">  398: 			require URI::Heuristic unless URI::Heuristic-&gt;can(&#39;uf_uristr&#39;);
</span><span class="">  399: 
</span><span class="">  400: 		$self-&gt;{cgi_site} = URI::Heuristic::uf_uristr($host);
</span><span class="">  401: 		# Remove trailing dots from the name.  They are legal in URLs
</span><span class="">  402: 		# and some sites link using them to avoid spoofing (nice)
</span><span class="">  403: 		$self-&gt;{cgi_site} =~ s/(.*)\.+$/$1/;  # Trim trailing dots
</span><span class="">  404: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  405: 		if($ENV{&#39;SERVER_NAME&#39;} &amp;&amp; ($host eq $ENV{&#39;SERVER_NAME&#39;}) &amp;&amp; (my $protocol = $self-&gt;protocol()) &amp;&amp; $self-&gt;protocol() ne &#39;http&#39;) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_405: Invert condition</b></li>
</ul></details>
<span class="">  406: 			$self-&gt;{cgi_site} =~ s/^http/$protocol/;
</span><span class="">  407: 		}
</span><span class="">  408: 	} else {
</span><span class="">  409: 		# Import necessary module
</span><span class="">  410: 		require Sys::Hostname unless Sys::Hostname-&gt;can(&#39;hostname&#39;);
</span><span class="">  411: 
</span><span class="">  412: 		$self-&gt;_debug(&#39;Falling back to using hostname&#39;);
</span><span class="">  413: 		$self-&gt;{cgi_site} = Sys::Hostname::hostname();
</span><span class="">  414: 	}
</span><span class="">  415: 
</span><span class="">  416: 	# Set site details if not already defined
</span><span class="">  417: 	$self-&gt;{site} ||= $self-&gt;{cgi_site};
</span><span class="">  418: 	$self-&gt;{site} =~ s/^https?:\/\/(.+)/$1/;
</span><span class="">  419: 	$self-&gt;{cgi_site} = ($self-&gt;protocol() || &#39;http&#39;) . &#39;://&#39; . $self-&gt;{cgi_site}
</span><span class="">  420: 		unless $self-&gt;{cgi_site} =~ /^https?:\/\//;
</span><span class="">  421: 
</span><span class="">  422: 	# Warn if site details could not be determined
</span><span class="">  423: 	$self-&gt;_warn(&#39;Could not determine site name&#39;) unless($self-&gt;{site} &amp;&amp; $self-&gt;{cgi_site});
</span><span class="">  424: 
</span><span class="">  425: 	# Log exit
</span><span class="">  426: 	$self-&gt;_trace(&#39;Leaving _find_site_details&#39;);
</span><span class="">  427: }
</span><span class="">  428: 
</span><span class="">  429: =head2 domain_name
</span><span class="">  430: 
</span><span class="">  431: Domain_name is the name of the controlling domain for this website.
</span><span class="">  432: Usually it will be similar to host_name, but will lack the http:// or www prefixes.
</span><span class="">  433: 
</span><span class="">  434: Can be called as a class method.
</span><span class="">  435: 
</span><span class="">  436: =cut
</span><span class="">  437: 
</span><span class="">  438: sub domain_name {
</span><span class="">  439: 	my $self = shift;
</span><span class="">  440: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  441: 	if(!ref($self)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_441: Invert condition</b></li>
</ul></details>
<span class="">  442: 		$self = __PACKAGE__-&gt;new();
</span><span class="">  443: 	}
</span><span class="">  444: 	return $self-&gt;{domain} if $self-&gt;{domain};
</span><span class="">  445: 
</span><span class="">  446: 	$self-&gt;_find_site_details();
</span><span class="">  447: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  448: 	if(my $site = $self-&gt;{site}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_448: Invert condition</b></li>
</ul></details>
<span class="">  449: 		$self-&gt;{domain} = ($site =~ /^www\.(.+)/) ? $1 : $site;
</span><span class="">  450: 	}
</span><span class="">  451: 
</span><span class="">  452: 	return $self-&gt;{domain};
</span><span class="">  453: }
</span><span class="">  454: 
</span><span class="">  455: =head2 cgi_host_url
</span><span class="">  456: 
</span><span class="">  457: Return the URL of the machine running the CGI script.
</span><span class="">  458: 
</span><span class="">  459: =cut
</span><span class="">  460: 
</span><span class="">  461: sub cgi_host_url {
</span><span class="">  462: 	my $self = shift;
</span><span class="">  463: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  464: 	unless($self-&gt;{cgi_site}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_464: Invert condition</b></li>
</ul></details>
<span class="">  465: 		$self-&gt;_find_site_details();
</span><span class="">  466: 	}
</span><span class="">  467: 
</span><span class="">  468: 	return $self-&gt;{cgi_site};
</span><span class="">  469: }
</span><span class="">  470: 
</span><span class="">  471: =head2 params
</span><span class="">  472: 
</span><span class="">  473: Returns a reference to a hash list of the CGI arguments.
</span><span class="">  474: 
</span><span class="">  475: CGI::Info helps you to test your script before deployment on a website:
</span><span class="">  476: if it is not in a CGI environment (e.g., the script is being tested from the
</span><span class="">  477: command line), the program&#39;s command line arguments (a list of key=value pairs)
</span><span class="">  478: are used, if there are no command line arguments,
</span><span class="">  479: then they are read from stdin as a list of key=value lines.
</span><span class="">  480: Also,
</span><span class="">  481: you can give one of --tablet, --search-engine,
</span><span class="">  482: --mobile and --robot to mimic those agents. For example:
</span><span class="">  483: 
</span><span class="">  484: 	./script.cgi --mobile name=Nigel
</span><span class="">  485: 
</span><span class="">  486: Returns undef if the parameters can&#39;t be determined or if none were given.
</span><span class="">  487: 
</span><span class="">  488: If an argument is given twice or more, then the values are put in a comma
</span><span class="">  489: separated string.
</span><span class="">  490: 
</span><span class="">  491: The returned hash value can be passed into L&lt;CGI::Untaint&gt;.
</span><span class="">  492: 
</span><span class="">  493: Takes four optional parameters: allow, logger and upload_dir.
</span><span class="">  494: The parameters are passed in a hash, or a reference to a hash.
</span><span class="">  495: The latter is more efficient since it puts less on the stack.
</span><span class="">  496: 
</span><span class="">  497: Allow is a reference to a hash list of CGI parameters that you will allow.
</span><span class="">  498: The value for each entry is either a permitted value,
</span><span class="">  499: a regular expression of permitted values for
</span><span class="">  500: the key,
</span><span class="">  501: a code reference,
</span><span class="">  502: or a hash of L&lt;Params::Validate::Strict&gt; rules.
</span><span class="">  503: Subroutine exceptions propagate normally, allowing custom error handling.
</span><span class="">  504: This works alongside existing regex and Params::Validate::Strict patterns.
</span><span class="">  505: A undef value means that any value will be allowed.
</span><span class="">  506: Arguments not in the list are silently ignored.
</span><span class="">  507: This is useful to help to block attacks on your site.
</span><span class="">  508: 
</span><span class="">  509: Upload_dir is a string containing a directory where files being uploaded are to
</span><span class="">  510: be stored.
</span><span class="">  511: It must be a writeable directory in the temporary area.
</span><span class="">  512: 
</span><span class="">  513: Takes an optional parameter logger, which is used for warnings and traces.
</span><span class="">  514: It can be an object that understands warn() and trace() messages,
</span><span class="">  515: such as a L&lt;Log::Log4perl&gt; or L&lt;Log::Any&gt; object,
</span><span class="">  516: a reference to code,
</span><span class="">  517: a reference to an array,
</span><span class="">  518: or a filename.
</span><span class="">  519: 
</span><span class="">  520: The allow, logger and upload_dir arguments can also be passed to the
</span><span class="">  521: constructor.
</span><span class="">  522: 
</span><span class="">  523: 	use CGI::Info;
</span><span class="">  524: 	use CGI::Untaint;
</span><span class="">  525: 	# ...
</span><span class="">  526: 	my $info = CGI::Info-&gt;new();
</span><span class="">  527: 	my %params;
</span><span class="">  528: 	if($info-&gt;params()) {
</span><span class="">  529: 		%params = %{$info-&gt;params()};
</span><span class="">  530: 	}
</span><span class="">  531: 	# ...
</span><span class="">  532: 	foreach(keys %params) {
</span><span class="">  533: 		print &quot;$_ =&gt; $params{$_}\n&quot;;
</span><span class="">  534: 	}
</span><span class="">  535: 	my $u = CGI::Untaint-&gt;new(%params);
</span><span class="">  536: 
</span><span class="">  537: 	use CGI::Info;
</span><span class="">  538: 	use CGI::IDS;
</span><span class="">  539: 	# ...
</span><span class="">  540: 	my $info = CGI::Info-&gt;new();
</span><span class="">  541: 	my $allowed = {
</span><span class="">  542: 		foo =&gt; qr/^\d*$/,	# foo must be a number, or empty
</span><span class="">  543: 		bar =&gt; undef,		# bar can be given and be any value
</span><span class="">  544: 		xyzzy =&gt; qr/^[\w\s-]+$/,	# must be alphanumeric
</span><span class="">  545: 						# to prevent XSS, and non-empty
</span><span class="">  546: 						# as a sanity check
</span><span class="">  547: 	};
</span><span class="">  548: 	# or
</span><span class="">  549: 	$allowed = {
</span><span class="">  550: 		email =&gt; { type =&gt; &#39;string&#39;, matches =&gt; qr/^[^@]+@[^@]+\.[^@]+$/ }, # String, basic email format check
</span><span class="">  551: 		age =&gt; { type =&gt; &#39;integer&#39;, min =&gt; 0, max =&gt; 150 }, # Integer between 0 and 150
</span><span class="">  552: 		bio =&gt; { type =&gt; &#39;string&#39;, optional =&gt; 1 }, # String, optional
</span><span class="">  553: 		ip_address =&gt; { type =&gt; &#39;string&#39;, matches =&gt; qr/^(?:[0-9]{1,3}\.){3}[0-9]{1,3}$/ }, #Basic IPv4 validation
</span><span class="">  554: 	};
</span><span class="">  555: 	my $paramsref = $info-&gt;params(allow =&gt; $allowed);
</span><span class="">  556: 	if(defined($paramsref)) {
</span><span class="">  557: 		my $ids = CGI::IDS-&gt;new();
</span><span class="">  558: 		$ids-&gt;set_scan_keys(scan_keys =&gt; 1);
</span><span class="">  559: 		if($ids-&gt;detect_attacks(request =&gt; $paramsref) &gt; 0) {
</span><span class="">  560: 			die &#39;horribly&#39;;
</span><span class="">  561: 		}
</span><span class="">  562: 	}
</span><span class="">  563: 
</span><span class="">  564: If the request is an XML request (i.e. the content type of the POST is text/xml),
</span><span class="">  565: CGI::Info will put the request into the params element &#39;XML&#39;, thus:
</span><span class="">  566: 
</span><span class="">  567: 	use CGI::Info;
</span><span class="">  568: 	# ...
</span><span class="">  569: 	my $info = CGI::Info-&gt;new();
</span><span class="">  570: 	my $paramsref = $info-&gt;params();	# See BUGS below
</span><span class="">  571: 	my $xml = $$paramsref{&#39;XML&#39;};
</span><span class="">  572: 	# ... parse and process the XML request in $xml
</span><span class="">  573: 
</span><span class="">  574: Carp if logger is not set and we detect something serious.
</span><span class="">  575: 
</span><span class="">  576: Blocks some attacks,
</span><span class="">  577: such as SQL and XSS injections,
</span><span class="">  578: mustleak and directory traversals,
</span><span class="">  579: thus creating a primitive web application firewall (WAF).
</span><span class="">  580: Warning - this is an extra layer, not a replacement for your other security layers.
</span><span class="">  581: 
</span><span class="">  582: =head3 Validation Subroutine Support
</span><span class="">  583: 
</span><span class="">  584: The C&lt;allow&gt; parameter accepts subroutine references for dynamic validation,
</span><span class="">  585: enabling complex parameter checks beyond static regex patterns.
</span><span class="">  586: These callbacks:
</span><span class="">  587: 
</span><span class="">  588: =over 4
</span><span class="">  589: 
</span><span class="">  590: =item * Receive three arguments: the parameter key, value and the C&lt;CGI::Info&gt; instance
</span><span class="">  591: 
</span><span class="">  592: =item * Must return a true value to allow the parameter, false to reject
</span><span class="">  593: 
</span><span class="">  594: =item * Can access other parameters through the instance for contextual validation
</span><span class="">  595: 
</span><span class="">  596: =back
</span><span class="">  597: 
</span><span class="">  598: Basic usage:
</span><span class="">  599: 
</span><span class="">  600:     CGI::Info-&gt;new(
</span><span class="">  601:         allow =&gt; {
</span><span class="">  602:             # Simple value check
</span><span class="">  603:             even_number =&gt; sub { ($_[1] % 2) == 0 },
</span><span class="">  604: 
</span><span class="">  605:             # Context-aware validation
</span><span class="">  606:             child_age =&gt; sub {
</span><span class="">  607:                 my ($key, $value, $info) = @_;
</span><span class="">  608:                 $info-&gt;param(&#39;is_parent&#39;) ? $value &lt;= 18 : 0
</span><span class="">  609:             }
</span><span class="">  610:         }
</span><span class="">  611:     );
</span><span class="">  612: 
</span><span class="">  613: Advanced features:
</span><span class="">  614: 
</span><span class="">  615:     # Combine with regex validation
</span><span class="">  616:     mixed_validation =&gt; {
</span><span class="">  617:         email =&gt; qr/@/,  # Regex check
</span><span class="">  618:         promo_code =&gt; \&amp;validate_promo_code  # Subroutine check
</span><span class="">  619:     }
</span><span class="">  620: 
</span><span class="">  621:     # Throw custom exceptions
</span><span class="">  622:     dangerous_param =&gt; sub {
</span><span class="">  623:         die &#39;Hacking attempt!&#39; if $_[1] =~ /DROP TABLE/;
</span><span class="">  624:         return 1;
</span><span class="">  625:     }
</span><span class="">  626: =cut
</span><span class="">  627: 
</span><span class="">  628: sub params {
</span><span class="">  629: 	my $self = shift;
</span><span class="">  630: 
</span><span class="">  631: 	my $params = Params::Get::get_params(undef, @_);
</span><span class="">  632: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  633: 	if((defined($self-&gt;{paramref})) &amp;&amp; ((!defined($params-&gt;{&#39;allow&#39;})) || defined($self-&gt;{allow}) &amp;&amp; ($params-&gt;{&#39;allow&#39;} eq $self-&gt;{allow}))) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_633: Invert condition</b></li>
</ul></details>
<span class="">  634: 		return $self-&gt;{paramref};
</span><span class="">  635: 	}
</span><span class="">  636: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  637: 	if(defined($params-&gt;{allow})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_637: Invert condition</b></li>
</ul></details>
<span class="">  638: 		$self-&gt;{allow} = $params-&gt;{allow};
</span><span class="">  639: 	}
</span><span class="">  640: 	# if(defined($params-&gt;{expect})) {
</span><span class="">  641: 		# if(ref($params-&gt;{expect}) eq &#39;ARRAY&#39;) {
</span><span class="">  642: 			# $self-&gt;{expect} = $params-&gt;{expect};
</span><span class="">  643: 			# $self-&gt;_warn(&#39;expect is deprecated, use allow instead&#39;);
</span><span class="">  644: 		# } else {
</span><span class="">  645: 			# $self-&gt;_warn(&#39;expect must be a reference to an array&#39;);
</span><span class="">  646: 		# }
</span><span class="">  647: 	# }
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  648: 	if(defined($params-&gt;{upload_dir})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_648: Invert condition</b></li>
</ul></details>
<span class="">  649: 		$self-&gt;{upload_dir} = $params-&gt;{upload_dir};
</span><span class="">  650: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  651: 	if(defined($params-&gt;{&#39;logger&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_651: Invert condition</b></li>
</ul></details>
<span class="">  652: 		$self-&gt;set_logger($params-&gt;{&#39;logger&#39;});
</span><span class="">  653: 	}
</span><span class="">  654: 	$self-&gt;_trace(&#39;Entering params&#39;);
</span><span class="">  655: 
</span><span class="">  656: 	my @pairs;
</span><span class="">  657: 	my $content_type = $ENV{&#39;CONTENT_TYPE&#39;};
</span><span class="">  658: 	my %FORM;
</span><span class="">  659: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  660: 	if((!$ENV{&#39;GATEWAY_INTERFACE&#39;}) || (!$ENV{&#39;REQUEST_METHOD&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_660: Invert condition</b></li>
</ul></details>
<span class="">  661: 		require IO::Interactive;
</span><span class="">  662: 		IO::Interactive-&gt;import();
</span><span class="">  663: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  664: 		if(@ARGV) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_664: Invert condition</b></li>
</ul></details>
<span class="">  665: 			@pairs = @ARGV;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  666: 			if(defined($pairs[0])) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_666: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  667: 				if($pairs[0] eq &#39;--robot&#39;) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_667: Invert condition</b></li>
</ul></details>
<span class="">  668: 					$self-&gt;{is_robot} = 1;
</span><span class="">  669: 					shift @pairs;
</span><span class="">  670: 				} elsif($pairs[0] eq &#39;--mobile&#39;) {
</span><span class="">  671: 					$self-&gt;{is_mobile} = 1;
</span><span class="">  672: 					shift @pairs;
</span><span class="">  673: 				} elsif($pairs[0] eq &#39;--search-engine&#39;) {
</span><span class="">  674: 					$self-&gt;{is_search_engine} = 1;
</span><span class="">  675: 					shift @pairs;
</span><span class="">  676: 				} elsif($pairs[0] eq &#39;--tablet&#39;) {
</span><span class="">  677: 					$self-&gt;{is_tablet} = 1;
</span><span class="">  678: 					shift @pairs;
</span><span class="">  679: 				}
</span><span class="">  680: 			}
</span><span class="">  681: 		} elsif($stdin_data) {
</span><span class="">  682: 			@pairs = split(/\n/, $stdin_data);
</span><span class="">  683: 		} elsif(IO::Interactive::is_interactive() &amp;&amp; !$self-&gt;{args_read}) {
</span><span class="">  684: 			# TODO:  Do I really need this anymore?
</span><span class="">  685: 			my $oldfh = select(STDOUT);
</span><span class="">  686: 			print &quot;Entering debug mode\n&quot;,
</span><span class="">  687: 				&quot;Enter key=value pairs - end with quit\n&quot;;
</span><span class="">  688: 			select($oldfh);
</span><span class="">  689: 
</span><span class="">  690: 			# Avoid prompting for the arguments more than once
</span><span class="">  691: 			# if just &#39;quit&#39; is entered
</span><span class="">  692: 			$self-&gt;{args_read} = 1;
</span><span class="">  693: 
</span><span class="">  694: 			while(&lt;STDIN&gt;) {
</span><span class="">  695: 				chop(my $line = $_);
</span><span class="">  696: 				$line =~ s/[\r\n]//g;
</span><span class="">  697: 				last if $line eq &#39;quit&#39;;
</span><span class="">  698: 				push(@pairs, $line);
</span><span class="">  699: 				$stdin_data .= &quot;$line\n&quot;;
</span><span class="">  700: 			}
</span><span class="">  701: 		}
</span><span class="">  702: 	} elsif(($ENV{&#39;REQUEST_METHOD&#39;} eq &#39;GET&#39;) || ($ENV{&#39;REQUEST_METHOD&#39;} eq &#39;HEAD&#39;)) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  703: 		if(my $query = $ENV{&#39;QUERY_STRING&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_703: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  704: 			if((defined($content_type)) &amp;&amp; ($content_type =~ /multipart\/form-data/i)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_704: Invert condition</b></li>
</ul></details>
<span class="">  705: 				$self-&gt;_warn(&#39;Multipart/form-data not supported for GET&#39;);
</span><span class="">  706: 				$self-&gt;{status} = 501;	# Not implemented
</span><span class="">  707: 				return;
</span><span class="">  708: 			}
</span><span class="">  709: 			$query =~ s/\\u0026/\&amp;/g;
</span><span class="">  710: 			@pairs = split(/&amp;/, $query);
</span><span class="">  711: 		} else {
</span><span class="">  712: 			return;
</span><span class="">  713: 		}
</span><span class="">  714: 	} elsif($ENV{&#39;REQUEST_METHOD&#39;} eq &#39;POST&#39;) {
</span><span class="">  715: 		my $content_length = $self-&gt;_get_env(&#39;CONTENT_LENGTH&#39;);
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  716: 		if((!defined($content_length)) || ($content_length =~ /\D/)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_716: Invert condition</b></li>
</ul></details>
<span class="">  717: 			$self-&gt;{status} = 411;
</span><span class="">  718: 			return;
</span><span class="">  719: 		}
</span><span class="survived-1 tooltip" data-tooltip="Boundary mutation survived. Add tests around edge values (e.g. min, max, off-by-one).">  720: 		if(($self-&gt;{max_upload_size} &gt;= 0) &amp;&amp; ($content_length &gt; $self-&gt;{max_upload_size})) {	# Set maximum posts
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 8, Killed: 7, Survived: 1)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_720: Numeric boundary flip > to >=</b></li>
<li><b>NUM_BOUNDARY_720: Numeric boundary flip >= to ></b></li>
<li><b>NUM_BOUNDARY_720: Numeric boundary flip >= to <</b></li>
<li><b>NUM_BOUNDARY_720: Numeric boundary flip >= to <=</b></li>
<li><b>NUM_BOUNDARY_720: Numeric boundary flip > to <</b></li>
<li><b>NUM_BOUNDARY_720: Numeric boundary flip > to <=</b></li>
<li><b>NUM_BOUNDARY_720: Numeric boundary flip > to ==</b></li>
<li><b>COND_INV_720: Invert condition</b></li>
</ul></details>
<span class="">  721: 			# TODO: Design a way to tell the caller to send HTTP
</span><span class="">  722: 			# status 413
</span><span class="">  723: 			$self-&gt;{status} = 413;
</span><span class="">  724: 			$self-&gt;_warn(&#39;Large upload prohibited&#39;);
</span><span class="">  725: 			return;
</span><span class="">  726: 		}
</span><span class="">  727: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  728: 		if((!defined($content_type)) || ($content_type =~ /application\/x-www-form-urlencoded/)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_728: Invert condition</b></li>
</ul></details>
<span class="">  729: 			my $buffer;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  730: 			if($stdin_data) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_730: Invert condition</b></li>
</ul></details>
<span class="">  731: 				$buffer = $stdin_data;
</span><span class="">  732: 			} else {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  733: 				if(read(STDIN, $buffer, $content_length) != $content_length) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_733: Invert condition</b></li>
</ul></details>
<span class="">  734: 					$self-&gt;_warn(&#39;POST failed: something else may have read STDIN&#39;);
</span><span class="">  735: 				}
</span><span class="">  736: 				$stdin_data = $buffer;
</span><span class="">  737: 			}
</span><span class="">  738: 			@pairs = split(/&amp;/, $buffer);
</span><span class="">  739: 
</span><span class="">  740: 			# if($ENV{&#39;QUERY_STRING&#39;}) {
</span><span class="">  741: 				# my @getpairs = split(/&amp;/, $ENV{&#39;QUERY_STRING&#39;});
</span><span class="">  742: 				# push(@pairs, @getpairs);
</span><span class="">  743: 			# }
</span><span class="">  744: 		} elsif($content_type =~ /multipart\/form-data/i) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  745: 			if(!defined($self-&gt;{upload_dir})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_745: Invert condition</b></li>
</ul></details>
<span class="">  746: 				$self-&gt;_warn({
</span><span class="">  747: 					warning =&gt; &#39;Attempt to upload a file when upload_dir has not been set&#39;
</span><span class="">  748: 				});
</span><span class="">  749: 				return;
</span><span class="">  750: 			}
</span><span class="">  751: 
</span><span class="">  752: 			# Validate &#39;upload_dir&#39;
</span><span class="">  753: 			# Ensure the upload directory is safe and accessible
</span><span class="">  754: 			# - Check permissions
</span><span class="">  755: 			# - Validate path to prevent directory traversal attacks
</span><span class="">  756: 			# TODO: Consider using a temporary directory for uploads and moving them later
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  757: 			if(!File::Spec-&gt;file_name_is_absolute($self-&gt;{upload_dir})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_757: Invert condition</b></li>
</ul></details>
<span class="">  758: 				$self-&gt;_warn({
</span><span class="">  759: 					warning =&gt; &quot;upload_dir $self-&gt;{upload_dir} isn&#39;t a full pathname&quot;
</span><span class="">  760: 				});
</span><span class="">  761: 				$self-&gt;status(500);
</span><span class="">  762: 				delete $self-&gt;{upload_dir};
</span><span class="">  763: 				return;
</span><span class="">  764: 			}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  765: 			if(!-d $self-&gt;{upload_dir}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_765: Invert condition</b></li>
</ul></details>
<span class="">  766: 				$self-&gt;_warn({
</span><span class="">  767: 					warning =&gt; &quot;upload_dir $self-&gt;{upload_dir} isn&#39;t a directory&quot;
</span><span class="">  768: 				});
</span><span class="">  769: 				$self-&gt;status(500);
</span><span class="">  770: 				delete $self-&gt;{upload_dir};
</span><span class="">  771: 				return;
</span><span class="">  772: 			}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  773: 			if(!-w $self-&gt;{upload_dir}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_773: Invert condition</b></li>
</ul></details>
<span class="">  774: 				delete $self-&gt;{paramref};
</span><span class="">  775: 				$self-&gt;_warn({
</span><span class="">  776: 					warning =&gt; &quot;upload_dir $self-&gt;{upload_dir} isn&#39;t writeable&quot;
</span><span class="">  777: 				});
</span><span class="">  778: 				$self-&gt;status(500);
</span><span class="">  779: 				delete $self-&gt;{upload_dir};
</span><span class="">  780: 				return;
</span><span class="">  781: 			}
</span><span class="">  782: 			my $tmpdir = $self-&gt;tmpdir();
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  783: 			if($self-&gt;{&#39;upload_dir&#39;} !~ /^\Q$tmpdir\E/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_783: Invert condition</b></li>
</ul></details>
<span class="">  784: 				$self-&gt;_warn({
</span><span class="">  785: 					warning =&gt; &#39;upload_dir &#39; . $self-&gt;{&#39;upload_dir&#39;} . &quot; isn&#39;t somewhere in the temporary area $tmpdir&quot;
</span><span class="">  786: 				});
</span><span class="">  787: 				$self-&gt;status(500);
</span><span class="">  788: 				delete $self-&gt;{upload_dir};
</span><span class="">  789: 				return;
</span><span class="">  790: 			}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  791: 			if($content_type =~ /boundary=(\S+)$/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_791: Invert condition</b></li>
</ul></details>
<span class="">  792: 				@pairs = $self-&gt;_multipart_data({
</span><span class="">  793: 					length =&gt; $content_length,
</span><span class="">  794: 					boundary =&gt; $1
</span><span class="">  795: 				});
</span><span class="">  796: 			}
</span><span class="">  797: 		} elsif($content_type =~ /text\/xml/i) {
</span><span class="">  798: 			my $buffer;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  799: 			if($stdin_data) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_799: Invert condition</b></li>
</ul></details>
<span class="">  800: 				$buffer = $stdin_data;
</span><span class="">  801: 			} else {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  802: 				if(read(STDIN, $buffer, $content_length) != $content_length) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_802: Invert condition</b></li>
</ul></details>
<span class="">  803: 					$self-&gt;_warn({
</span><span class="">  804: 						warning =&gt; &#39;XML failed: something else may have read STDIN&#39;
</span><span class="">  805: 					});
</span><span class="">  806: 				}
</span><span class="">  807: 				$stdin_data = $buffer;
</span><span class="">  808: 			}
</span><span class="">  809: 
</span><span class="">  810: 			$FORM{XML} = $buffer;
</span><span class="">  811: 
</span><span class="">  812: 			$self-&gt;{paramref} = \%FORM;
</span><span class="">  813: 
</span><span class="">  814: 			return \%FORM;
</span><span class="">  815: 		} elsif($content_type =~ /application\/json/i) {
</span><span class="">  816: 			require JSON::MaybeXS &amp;&amp; JSON::MaybeXS-&gt;import() unless JSON::MaybeXS-&gt;can(&#39;parse_json&#39;);
</span><span class="">  817: 			# require JSON::MaybeXS;
</span><span class="">  818: 			# JSON::MaybeXS-&gt;import();
</span><span class="">  819: 
</span><span class="">  820: 			my $buffer;
</span><span class="">  821: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  822: 			if($stdin_data) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_822: Invert condition</b></li>
</ul></details>
<span class="">  823: 				$buffer = $stdin_data;
</span><span class="">  824: 			} else {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  825: 				if(read(STDIN, $buffer, $content_length) != $content_length) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_825: Invert condition</b></li>
</ul></details>
<span class="">  826: 					$self-&gt;_warn({
</span><span class="">  827: 						warning =&gt; &#39;read failed: something else may have read STDIN&#39;
</span><span class="">  828: 					});
</span><span class="">  829: 				}
</span><span class="">  830: 				$stdin_data = $buffer;
</span><span class="">  831: 			}
</span><span class="">  832: 			# JSON::Parse::assert_valid_json($buffer);
</span><span class="">  833: 			# my $paramref = JSON::Parse::parse_json($buffer);
</span><span class="">  834: 			my $paramref = decode_json($buffer);
</span><span class="">  835: 			foreach my $key(keys(%{$paramref})) {
</span><span class="">  836: 				push @pairs, &quot;$key=&quot; . $paramref-&gt;{$key};
</span><span class="">  837: 			}
</span><span class="">  838: 		} else {
</span><span class="">  839: 			my $buffer;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  840: 			if($stdin_data) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_840: Invert condition</b></li>
</ul></details>
<span class="">  841: 				$buffer = $stdin_data;
</span><span class="">  842: 			} else {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  843: 				if(read(STDIN, $buffer, $content_length) != $content_length) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_843: Invert condition</b></li>
</ul></details>
<span class="">  844: 					$self-&gt;_warn({
</span><span class="">  845: 						warning =&gt; &#39;read failed: something else may have read STDIN&#39;
</span><span class="">  846: 					});
</span><span class="">  847: 				}
</span><span class="">  848: 				$stdin_data = $buffer;
</span><span class="">  849: 			}
</span><span class="">  850: 
</span><span class="">  851: 			$self-&gt;_warn({
</span><span class="">  852: 				warning =&gt; &quot;POST: Invalid or unsupported content type: $content_type: $buffer&quot;,
</span><span class="">  853: 			});
</span><span class="">  854: 		}
</span><span class="">  855: 	} elsif($ENV{&#39;REQUEST_METHOD&#39;} eq &#39;OPTIONS&#39;) {
</span><span class="">  856: 		$self-&gt;{status} = 405;
</span><span class="">  857: 		return;
</span><span class="">  858: 	} elsif($ENV{&#39;REQUEST_METHOD&#39;} eq &#39;DELETE&#39;) {
</span><span class="">  859: 		$self-&gt;{status} = 405;
</span><span class="">  860: 		return;
</span><span class="">  861: 	} else {
</span><span class="">  862: 		# TODO: Design a way to tell the caller to send HTTP
</span><span class="">  863: 		# status 501
</span><span class="">  864: 		$self-&gt;{status} = 501;
</span><span class="">  865: 		$self-&gt;_warn({
</span><span class="">  866: 			warning =&gt; &#39;Use POST, GET or HEAD&#39;
</span><span class="">  867: 		});
</span><span class="">  868: 	}
</span><span class="">  869: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  870: 	unless(scalar @pairs) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_870: Invert condition</b></li>
</ul></details>
<span class="">  871: 		return;
</span><span class="">  872: 	}
</span><span class="">  873: 
</span><span class="">  874: 	require String::Clean::XSS;
</span><span class="">  875: 	String::Clean::XSS-&gt;import();
</span><span class="">  876: 	# require String::EscapeCage;
</span><span class="">  877: 	# String::EscapeCage-&gt;import();
</span><span class="">  878: 
</span><span class="">  879: 	foreach my $arg (@pairs) {
</span><span class="">  880: 		my($key, $value) = split(/=/, $arg, 2);
</span><span class="">  881: 
</span><span class="">  882: 		next unless($key);
</span><span class="">  883: 
</span><span class="">  884: 		$key =~ s/\0//g;	# Strip encoded NUL byte poison
</span><span class="">  885: 		$key =~ s/%00//g;	# Strip NUL byte poison
</span><span class="">  886: 		$key =~ s/%([a-fA-F\d][a-fA-F\d])/pack(&quot;C&quot;, hex($1))/eg;
</span><span class="">  887: 		$key =~ tr/+/ /;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  888: 		if(defined($value)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_888: Invert condition</b></li>
</ul></details>
<span class="">  889: 			$value =~ s/\0//g;	# Strip NUL byte poison
</span><span class="">  890: 			$value =~ s/%00//g;	# Strip encoded NUL byte poison
</span><span class="">  891: 			$value =~ s/%([a-fA-F\d][a-fA-F\d])/pack(&quot;C&quot;, hex($1))/eg;
</span><span class="">  892: 			$value =~ tr/+/ /;
</span><span class="">  893: 		} else {
</span><span class="">  894: 			$value = &#39;&#39;;
</span><span class="">  895: 		}
</span><span class="">  896: 
</span><span class="">  897: 		$key = _sanitise_input($key);
</span><span class="">  898: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  899: 		if($self-&gt;{allow}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_899: Invert condition</b></li>
</ul></details>
<span class="">  900: 			# Is this a permitted argument?
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  901: 			if(!exists($self-&gt;{allow}-&gt;{$key})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_901: Invert condition</b></li>
</ul></details>
<span class="">  902: 				$self-&gt;_info(&quot;Discard unallowed argument &#39;$key&#39;&quot;);
</span><span class="">  903: 				$self-&gt;status(422);
</span><span class="">  904: 				next;	# Skip to the next parameter
</span><span class="">  905: 			}
</span><span class="">  906: 
</span><span class="">  907: 			# Do we allow any value, or must it be validated?
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  908: 			if(defined(my $schema = $self-&gt;{allow}-&gt;{$key})) {	# Get the schema for this key
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_908: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  909: 				if(!ref($schema)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_909: Invert condition</b></li>
</ul></details>
<span class="">  910: 					# Can only contain one value
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  911: 					if($value ne $schema) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_911: Invert condition</b></li>
</ul></details>
<span class="">  912: 						$self-&gt;_info(&quot;Block $key = $value&quot;);
</span><span class="">  913: 						$self-&gt;status(422);
</span><span class="">  914: 						next;	# Skip to the next parameter
</span><span class="">  915: 					}
</span><span class="">  916: 				} elsif(ref($schema) eq &#39;Regexp&#39;) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  917: 					if($value !~ $schema) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_917: Invert condition</b></li>
</ul></details>
<span class="">  918: 						# Simple regex
</span><span class="">  919: 						$self-&gt;_info(&quot;Block $key = $value&quot;);
</span><span class="">  920: 						$self-&gt;status(422);
</span><span class="">  921: 						next;	# Skip to the next parameter
</span><span class="">  922: 					}
</span><span class="">  923: 				} elsif(ref($schema) eq &#39;CODE&#39;) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  924: 					unless($schema-&gt;($key, $value, $self)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_924: Invert condition</b></li>
</ul></details>
<span class="">  925: 						$self-&gt;_info(&quot;Block $key = $value&quot;);
</span><span class="">  926: 						next;
</span><span class="">  927: 					}
</span><span class="">  928: 				} else {
</span><span class="">  929: 					# Set of rules
</span><span class="">  930: 					eval {
</span><span class="">  931: 						$value = Params::Validate::Strict::validate_strict({
</span><span class="">  932: 							schema =&gt; { $key =&gt; $schema },
</span><span class="">  933: 							args =&gt; { $key =&gt; $value },
</span><span class="">  934: 							unknown_parameter_handler =&gt; &#39;die&#39;,
</span><span class="">  935: 							logger =&gt; $self-&gt;{&#39;logger&#39;}
</span><span class="">  936: 						});
</span><span class="">  937: 					};
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  938: 					if($@) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_938: Invert condition</b></li>
</ul></details>
<span class="">  939: 						$self-&gt;_info(&quot;Block $key = $value: $@&quot;);
</span><span class="">  940: 						$self-&gt;status(422);
</span><span class="">  941: 						next;	# Skip to the next parameter
</span><span class="">  942: 					}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  943: 					if(scalar keys %{$value}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_943: Invert condition</b></li>
</ul></details>
<span class="">  944: 						$value = $value-&gt;{$key};
</span><span class="">  945: 					} else {
</span><span class="">  946: 						$self-&gt;_info(&quot;Block $key = $value&quot;);
</span><span class="">  947: 						$self-&gt;status(422);
</span><span class="">  948: 						next;	# Skip to the next parameter
</span><span class="">  949: 					}
</span><span class="">  950: 				}
</span><span class="">  951: 			}
</span><span class="">  952: 		}
</span><span class="">  953: 
</span><span class="">  954: 		# if($self-&gt;{expect} &amp;&amp; (List::Util::none { $_ eq $key } @{$self-&gt;{expect}})) {
</span><span class="">  955: 			# next;
</span><span class="">  956: 		# }
</span><span class="">  957: 		my $orig_value = $value;
</span><span class="">  958: 		$value = _sanitise_input($value);
</span><span class="">  959: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  960: 		if((!defined($ENV{&#39;REQUEST_METHOD&#39;})) || ($ENV{&#39;REQUEST_METHOD&#39;} eq &#39;GET&#39;)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_960: Invert condition</b></li>
</ul></details>
<span class="">  961: 			# From http://www.symantec.com/connect/articles/detection-sql-injection-and-cross-site-scripting-attacks
</span><span class="">  962: 			# Facebook FBCLID can have &quot;--&quot;
</span><span class="">  963: 			# if(($value =~ /(\%27)|(\&#39;)|(\-\-)|(\%23)|(\#)/ix) ||
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  964: 			if(($value =~ /(\%27)|(\&#39;)|(\%23)|(\#)/ix) ||
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_964: Invert condition</b></li>
</ul></details>
<span class="">  965: 			   ($value =~ /((\%3D)|(=))[^\n]*((\%27)|(\&#39;)|(\-\-)|(\%3B)|(;))/i) ||
</span><span class="">  966: 			   ($value =~ /\w*((\%27)|(\&#39;))((\%6F)|o|(\%4F))((\%72)|r|(\%52))\s*(OR|AND|UNION|SELECT|--)/ix) ||
</span><span class="">  967: 			   ($value =~ /((\%27)|(\&#39;))union/ix) ||
</span><span class="">  968: 			   ($value =~ /select[[a-z]\s\*]from/ix) ||
</span><span class="">  969: 			   ($value =~ /\sAND\s1=1/ix) ||
</span><span class="">  970: 			   ($value =~ /\sOR\s.+\sAND\s/) ||
</span><span class="">  971: 			   ($value =~ /\/\*\*\/ORDER\/\*\*\/BY\/\*\*/ix) ||
</span><span class="">  972: 			   ($value =~ /\/AND\/.+\(SELECT\//) ||	# United/**/States)/**/AND/**/(SELECT/**/6734/**/FROM/**/(SELECT(SLEEP(5)))lRNi)/**/AND/**/(8984=8984
</span><span class="">  973: 			   ($value =~ /exec(\s|\+)+(s|x)p\w+/ix)) {
</span><span class="">  974: 				$self-&gt;status(403);
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  975: 				if($ENV{&#39;REMOTE_ADDR&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_975: Invert condition</b></li>
</ul></details>
<span class="">  976: 					$self-&gt;_warn($ENV{&#39;REMOTE_ADDR&#39;} . &quot;: SQL injection attempt blocked for &#39;$key=$value&#39;&quot;);
</span><span class="">  977: 				} else {
</span><span class="">  978: 					$self-&gt;_warn(&quot;SQL injection attempt blocked for &#39;$key=$value&#39;&quot;);
</span><span class="">  979: 				}
</span><span class="">  980: 				return;
</span><span class="">  981: 			}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  982: 			if(my $agent = $ENV{&#39;HTTP_USER_AGENT&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_982: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  983: 				if(($agent =~ /SELECT.+AND.+/) || ($agent =~ /ORDER BY /) || ($agent =~ / OR NOT /) || ($agent =~ / AND \d+=\d+/) || ($agent =~ /THEN.+ELSE.+END/) || ($agent =~ /.+AND.+SELECT.+/) || ($agent =~ /\sAND\s.+\sAND\s/)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_983: Invert condition</b></li>
</ul></details>
<span class="">  984: 					$self-&gt;status(403);
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  985: 					if($ENV{&#39;REMOTE_ADDR&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_985: Invert condition</b></li>
</ul></details>
<span class="">  986: 						$self-&gt;_warn($ENV{&#39;REMOTE_ADDR&#39;} . &quot;: SQL injection attempt blocked for &#39;$agent&#39;&quot;);
</span><span class="">  987: 					} else {
</span><span class="">  988: 						$self-&gt;_warn(&quot;SQL injection attempt blocked for &#39;$agent&#39;&quot;);
</span><span class="">  989: 					}
</span><span class="">  990: 					return;
</span><span class="">  991: 				}
</span><span class="">  992: 			}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic.">  993: 			if(($value =~ /((\%3C)|&lt;)((\%2F)|\/)*[a-z0-9\%]+((\%3E)|&gt;)/ix) ||
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_993: Invert condition</b></li>
</ul></details>
<span class="">  994: 			   ($value =~ /((\%3C)|&lt;)[^\n]+((\%3E)|&gt;)/i) ||
</span><span class="">  995: 			   ($orig_value =~ /((\%3C)|&lt;)((\%2F)|\/)*[a-z0-9\%]+((\%3E)|&gt;)/ix) ||
</span><span class="">  996: 			   ($orig_value =~ /((\%3C)|&lt;)[^\n]+((\%3E)|&gt;)/i)) {
</span><span class="">  997: 				$self-&gt;status(403);
</span><span class="">  998: 				$self-&gt;_warn(&quot;XSS injection attempt blocked for &#39;$value&#39;&quot;);
</span><span class="">  999: 				return;
</span><span class=""> 1000: 			}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1001: 			if($value =~ /mustleak\.com\//) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1001: Invert condition</b></li>
</ul></details>
<span class=""> 1002: 				$self-&gt;status(403);
</span><span class=""> 1003: 				$self-&gt;_warn(&quot;Blocked mustleak attack for &#39;$key&#39;&quot;);
</span><span class=""> 1004: 				return;
</span><span class=""> 1005: 			}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1006: 			if($value =~ /\.\.\//) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1006: Invert condition</b></li>
</ul></details>
<span class=""> 1007: 				$self-&gt;status(403);
</span><span class=""> 1008: 				$self-&gt;_warn(&quot;Blocked directory traversal attack for &#39;$key&#39;&quot;);
</span><span class=""> 1009: 				return;
</span><span class=""> 1010: 			}
</span><span class=""> 1011: 		}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1012: 		if(length($value) &gt; 0) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 5, Killed: 5, Survived: 0)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_1012: Numeric boundary flip > to <</b></li>
<li><b>NUM_BOUNDARY_1012: Numeric boundary flip > to >=</b></li>
<li><b>NUM_BOUNDARY_1012: Numeric boundary flip > to <=</b></li>
<li><b>NUM_BOUNDARY_1012: Numeric boundary flip > to ==</b></li>
<li><b>COND_INV_1012: Invert condition</b></li>
</ul></details>
<span class=""> 1013: 			# Don&#39;t add if it&#39;s already there
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1014: 			if($FORM{$key} &amp;&amp; ($FORM{$key} ne $value)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1014: Invert condition</b></li>
</ul></details>
<span class=""> 1015: 				$FORM{$key} .= &quot;,$value&quot;;
</span><span class=""> 1016: 			} else {
</span><span class=""> 1017: 				$FORM{$key} = $value;
</span><span class=""> 1018: 			}
</span><span class=""> 1019: 		}
</span><span class=""> 1020: 	}
</span><span class=""> 1021: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1022: 	unless(%FORM) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1022: Invert condition</b></li>
</ul></details>
<span class=""> 1023: 		return;
</span><span class=""> 1024: 	}
</span><span class=""> 1025: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1026: 	if($self-&gt;{&#39;logger&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1026: Invert condition</b></li>
</ul></details>
<span class=""> 1027: 		while(my ($key,$value) = each %FORM) {
</span><span class=""> 1028: 			$self-&gt;_debug(&quot;$key=$value&quot;);
</span><span class=""> 1029: 		}
</span><span class=""> 1030: 	}
</span><span class=""> 1031: 
</span><span class=""> 1032: 	$self-&gt;{paramref} = \%FORM;
</span><span class=""> 1033: 
</span><span class=""> 1034: 	return Return::Set::set_return(\%FORM, { type =&gt; &#39;hashref&#39;, min =&gt; 1 });
</span><span class=""> 1035: }
</span><span class=""> 1036: 
</span><span class=""> 1037: =head2 param($field)
</span><span class=""> 1038: 
</span><span class=""> 1039: Get a single parameter from the query string.
</span><span class=""> 1040: Takes an optional single string parameter which is the argument to return. If
</span><span class=""> 1041: that parameter is not given param() is a wrapper to params() with no arguments.
</span><span class=""> 1042: 
</span><span class=""> 1043: 	use CGI::Info;
</span><span class=""> 1044: 	# ...
</span><span class=""> 1045: 	my $info = CGI::Info-&gt;new();
</span><span class=""> 1046: 	my $bar = $info-&gt;param(&#39;foo&#39;);
</span><span class=""> 1047: 
</span><span class=""> 1048: If the requested parameter isn&#39;t in the allowed list, an error message will
</span><span class=""> 1049: be thrown:
</span><span class=""> 1050: 
</span><span class=""> 1051: 	use CGI::Info;
</span><span class=""> 1052: 	my $allowed = {
</span><span class=""> 1053: 		foo =&gt; qr/\d+/
</span><span class=""> 1054: 	};
</span><span class=""> 1055: 	my $xyzzy = $info-&gt;params(allow =&gt; $allowed);
</span><span class=""> 1056: 	my $bar = $info-&gt;param(&#39;bar&#39;);  # Gives an error message
</span><span class=""> 1057: 
</span><span class=""> 1058: Returns undef if the requested parameter was not given
</span><span class=""> 1059: 
</span><span class=""> 1060: =over 4
</span><span class=""> 1061: 
</span><span class=""> 1062: =item $field
</span><span class=""> 1063: 
</span><span class=""> 1064: Optional field to be retrieved.
</span><span class=""> 1065: If omitted, all the parameters are returned.
</span><span class=""> 1066: 
</span><span class=""> 1067: =back
</span><span class=""> 1068: 
</span><span class=""> 1069: =cut
</span><span class=""> 1070: 
</span><span class=""> 1071: sub param {
</span><span class=""> 1072: 	my ($self, $field) = @_;
</span><span class=""> 1073: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1074: 	if(!defined($field)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1074: Invert condition</b></li>
</ul></details>
<span class=""> 1075: 		return $self-&gt;params();
</span><span class=""> 1076: 	}
</span><span class=""> 1077: 	# Is this a permitted argument?
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1078: 	if($self-&gt;{allow} &amp;&amp; !exists($self-&gt;{allow}-&gt;{$field})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1078: Invert condition</b></li>
</ul></details>
<span class=""> 1079: 		$self-&gt;_warn({
</span><span class=""> 1080: 			warning =&gt; &quot;param: $field isn&#39;t in the allow list&quot;
</span><span class=""> 1081: 		});
</span><span class=""> 1082: 		return;
</span><span class=""> 1083: 	}
</span><span class=""> 1084: 
</span><span class=""> 1085: 	# Prevent deep recursion which can happen when a validation routine calls param()
</span><span class=""> 1086: 	my $allow;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1087: 	if($self-&gt;{in_param} &amp;&amp; $self-&gt;{allow}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1087: Invert condition</b></li>
</ul></details>
<span class=""> 1088: 		$allow = delete $self-&gt;{allow};
</span><span class=""> 1089: 	}
</span><span class=""> 1090: 	$self-&gt;{in_param} = 1;
</span><span class=""> 1091: 
</span><span class=""> 1092: 	my $params = $self-&gt;params();
</span><span class=""> 1093: 
</span><span class=""> 1094: 	$self-&gt;{in_param} = 0;
</span><span class=""> 1095: 	$self-&gt;{allow} = $allow if($allow);
</span><span class=""> 1096: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1097: 	if($params) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1097: Invert condition</b></li>
</ul></details>
<span class=""> 1098: 		return Return::Set::set_return($params-&gt;{$field}, { type =&gt; &#39;string&#39; });
</span><span class=""> 1099: 	}
</span><span class=""> 1100: }
</span><span class=""> 1101: 
</span><span class=""> 1102: sub _sanitise_input($) {
</span><span class=""> 1103: 	my $arg = shift;
</span><span class=""> 1104: 
</span><span class=""> 1105: 	return if(!defined($arg));
</span><span class=""> 1106: 
</span><span class=""> 1107: 	# Remove hacking attempts and spaces
</span><span class=""> 1108: 	$arg =~ s/[\r\n]//g;
</span><span class=""> 1109: 	$arg =~ s/\s+$//;
</span><span class=""> 1110: 	$arg =~ s/^\s//;
</span><span class=""> 1111: 
</span><span class=""> 1112: 	$arg =~ s/&lt;!--.*--&gt;//g;
</span><span class=""> 1113: 	# Allow :
</span><span class=""> 1114: 	# $arg =~ s/[;&lt;&gt;\*|`&amp;\$!?#\(\)\[\]\{\}&#39;&quot;\\\r]//g;
</span><span class=""> 1115: 
</span><span class=""> 1116: 	# return $arg;
</span><span class=""> 1117: 	# return String::EscapeCage-&gt;new(convert_XSS($arg))-&gt;escapecstring();
</span><span class=""> 1118: 	return convert_XSS($arg);
</span><span class=""> 1119: }
</span><span class=""> 1120: 
</span><span class=""> 1121: sub _multipart_data {
</span><span class=""> 1122: 	my ($self, $args) = @_;
</span><span class=""> 1123: 
</span><span class=""> 1124: 	$self-&gt;_trace(&#39;Entering _multipart_data&#39;);
</span><span class=""> 1125: 
</span><span class=""> 1126: 	my $total_bytes = $$args{length};
</span><span class=""> 1127: 
</span><span class=""> 1128: 	$self-&gt;_debug(&quot;_multipart_data: total_bytes = $total_bytes&quot;);
</span><span class=""> 1129: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1130: 	if($total_bytes == 0) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 2, Killed: 2, Survived: 0)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_1130: Numeric boundary flip == to !=</b></li>
<li><b>COND_INV_1130: Invert condition</b></li>
</ul></details>
<span class=""> 1131: 		return;
</span><span class=""> 1132: 	}
</span><span class=""> 1133: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1134: 	unless($stdin_data) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1134: Invert condition</b></li>
</ul></details>
<span class=""> 1135: 		while(&lt;STDIN&gt;) {
</span><span class=""> 1136: 			chop(my $line = $_);
</span><span class=""> 1137: 			$line =~ s/[\r\n]//g;
</span><span class=""> 1138: 			$stdin_data .= &quot;$line\n&quot;;
</span><span class=""> 1139: 		}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1140: 		if(!$stdin_data) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1140: Invert condition</b></li>
</ul></details>
<span class=""> 1141: 			return;
</span><span class=""> 1142: 		}
</span><span class=""> 1143: 	}
</span><span class=""> 1144: 
</span><span class=""> 1145: 	my $boundary = $$args{boundary};
</span><span class=""> 1146: 
</span><span class=""> 1147: 	my @pairs;
</span><span class=""> 1148: 	my $writing_file = 0;
</span><span class=""> 1149: 	my $key;
</span><span class=""> 1150: 	my $value;
</span><span class=""> 1151: 	my $in_header = 0;
</span><span class=""> 1152: 	my $fout;
</span><span class=""> 1153: 
</span><span class=""> 1154: 	foreach my $line(split(/\n/, $stdin_data)) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1155: 		if($line =~ /^--\Q$boundary\E--$/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1155: Invert condition</b></li>
</ul></details>
<span class=""> 1156: 			last;
</span><span class=""> 1157: 		}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1158: 		if($line =~ /^--\Q$boundary\E$/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1158: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1159: 			if($writing_file) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1159: Invert condition</b></li>
</ul></details>
<span class=""> 1160: 				close $fout;
</span><span class=""> 1161: 				$writing_file = 0;
</span><span class=""> 1162: 			} elsif(defined($key)) {
</span><span class=""> 1163: 				push(@pairs, &quot;$key=$value&quot;);
</span><span class=""> 1164: 				$value = undef;
</span><span class=""> 1165: 			}
</span><span class=""> 1166: 			$in_header = 1;
</span><span class=""> 1167: 		} elsif($in_header) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1168: 			if(length($line) == 0) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 2, Killed: 2, Survived: 0)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_1168: Numeric boundary flip == to !=</b></li>
<li><b>COND_INV_1168: Invert condition</b></li>
</ul></details>
<span class=""> 1169: 				$in_header = 0;
</span><span class=""> 1170: 			} elsif($line =~ /^Content-Disposition: (.+)/i) {
</span><span class=""> 1171: 				my $field = $1;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1172: 				if($field =~ /name=&quot;(.+?)&quot;/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1172: Invert condition</b></li>
</ul></details>
<span class=""> 1173: 					$key = $1;
</span><span class=""> 1174: 				}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1175: 				if($field =~ /filename=&quot;(.+)?&quot;/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1175: Invert condition</b></li>
</ul></details>
<span class=""> 1176: 					my $filename = $1;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1177: 					unless(defined($filename)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1177: Invert condition</b></li>
</ul></details>
<span class=""> 1178: 						$self-&gt;_warn(&#39;No upload filename given&#39;);
</span><span class=""> 1179: 					} elsif($filename =~ /[\\\/\|]/) {
</span><span class=""> 1180: 						$self-&gt;_warn(&quot;Disallowing invalid filename: $filename&quot;);
</span><span class=""> 1181: 					} else {
</span><span class=""> 1182: 						$filename = $self-&gt;_create_file_name({
</span><span class=""> 1183: 							filename =&gt; $filename
</span><span class=""> 1184: 						});
</span><span class=""> 1185: 
</span><span class=""> 1186: 						# Don&#39;t do this since it taints the string and I can&#39;t work out how to untaint it
</span><span class=""> 1187: 						# my $full_path = Cwd::realpath(File::Spec-&gt;catfile($self-&gt;{upload_dir}, $filename));
</span><span class=""> 1188: 						# $full_path =~ m/^(\/[\w\.]+)$/;
</span><span class=""> 1189: 						my $full_path = File::Spec-&gt;catfile($self-&gt;{upload_dir}, $filename);
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1190: 						unless(open($fout, &#39;&gt;&#39;, $full_path)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1190: Invert condition</b></li>
</ul></details>
<span class=""> 1191: 							$self-&gt;_warn(&quot;Can&#39;t open $full_path&quot;);
</span><span class=""> 1192: 						}
</span><span class=""> 1193: 						$writing_file = 1;
</span><span class=""> 1194: 						push(@pairs, &quot;$key=$filename&quot;);
</span><span class=""> 1195: 					}
</span><span class=""> 1196: 				}
</span><span class=""> 1197: 			}
</span><span class=""> 1198: 			# TODO: handle Content-Type: text/plain, etc.
</span><span class=""> 1199: 		} else {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1200: 			if($writing_file) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1200: Invert condition</b></li>
</ul></details>
<span class=""> 1201: 				print $fout &quot;$line\n&quot;;
</span><span class=""> 1202: 			} else {
</span><span class=""> 1203: 				$value .= $line;
</span><span class=""> 1204: 			}
</span><span class=""> 1205: 		}
</span><span class=""> 1206: 	}
</span><span class=""> 1207: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1208: 	if($writing_file) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1208: Invert condition</b></li>
</ul></details>
<span class=""> 1209: 		close $fout;
</span><span class=""> 1210: 	}
</span><span class=""> 1211: 
</span><span class=""> 1212: 	$self-&gt;_trace(&#39;Leaving _multipart_data&#39;);
</span><span class=""> 1213: 
</span><span class=""> 1214: 	return @pairs;
</span><span class=""> 1215: }
</span><span class=""> 1216: 
</span><span class=""> 1217: # Robust filename generation (preventing overwriting)
</span><span class=""> 1218: sub _create_file_name {
</span><span class=""> 1219: 	my ($self, $args) = @_;
</span><span class=""> 1220: 	my $filename = $$args{filename} . &#39;_&#39; . time;
</span><span class=""> 1221: 
</span><span class=""> 1222: 	my $counter = 0;
</span><span class=""> 1223: 	my $rc;
</span><span class=""> 1224: 
</span><span class=""> 1225: 	do {
</span><span class=""> 1226: 		$rc = $filename . ($counter ? &quot;_$counter&quot; : &#39;&#39;);
</span><span class=""> 1227: 		$counter++;
</span><span class=""> 1228: 	} until(! -e $rc);	# Check if file exists
</span><span class=""> 1229: 
</span><span class=""> 1230: 	return $rc;
</span><span class=""> 1231: }
</span><span class=""> 1232: 
</span><span class=""> 1233: # Untaint a filename. Regex from CGI::Untaint::Filenames
</span><span class=""> 1234: sub _untaint_filename {
</span><span class=""> 1235: 	my ($self, $args) = @_;
</span><span class=""> 1236: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1237: 	if($$args{filename} =~ /(^[\w\+_\040\#\(\)\{\}\[\]\/\-\^,\.:;&amp;%@\\~]+\$?$)/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1237: Invert condition</b></li>
</ul></details>
<span class=""> 1238: 		return $1;
</span><span class=""> 1239: 	}
</span><span class=""> 1240: 	# return undef;
</span><span class=""> 1241: }
</span><span class=""> 1242: 
</span><span class=""> 1243: =head2 is_mobile
</span><span class=""> 1244: 
</span><span class=""> 1245: Returns a boolean if the website is being viewed on a mobile
</span><span class=""> 1246: device such as a smartphone.
</span><span class=""> 1247: All tablets are mobile, but not all mobile devices are tablets.
</span><span class=""> 1248: 
</span><span class=""> 1249: Can be overriden by the IS_MOBILE environment setting
</span><span class=""> 1250: 
</span><span class=""> 1251: =cut
</span><span class=""> 1252: 
</span><span class=""> 1253: sub is_mobile {
</span><span class=""> 1254: 	my $self = shift;
</span><span class=""> 1255: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1256: 	if(defined($self-&gt;{is_mobile})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1256: Invert condition</b></li>
</ul></details>
<span class=""> 1257: 		return $self-&gt;{is_mobile};
</span><span class=""> 1258: 	}
</span><span class=""> 1259: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1260: 	if($ENV{&#39;IS_MOBILE&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1260: Invert condition</b></li>
</ul></details>
<span class=""> 1261: 		return $ENV{&#39;IS_MOBILE&#39;}
</span><span class=""> 1262: 	}
</span><span class=""> 1263: 
</span><span class=""> 1264: 	# Support Sec-CH-UA-Mobile
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1265: 	if(my $ch_ua_mobile = $ENV{&#39;HTTP_SEC_CH_UA_MOBILE&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1265: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1266: 		if($ch_ua_mobile eq &#39;?1&#39;) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1266: Invert condition</b></li>
</ul></details>
<span class=""> 1267: 			$self-&gt;{is_mobile} = 1;
</span><span class=""> 1268: 			return 1;
</span><span class=""> 1269: 		}
</span><span class=""> 1270: 	}
</span><span class=""> 1271: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1272: 	if($ENV{&#39;HTTP_X_WAP_PROFILE&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1272: Invert condition</b></li>
</ul></details>
<span class=""> 1273: 		# E.g. Blackberry
</span><span class=""> 1274: 		# TODO: Check the sanity of this variable
</span><span class=""> 1275: 		$self-&gt;{is_mobile} = 1;
</span><span class=""> 1276: 		return 1;
</span><span class=""> 1277: 	}
</span><span class=""> 1278: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1279: 	if(my $agent = $ENV{&#39;HTTP_USER_AGENT&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1279: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1280: 		if($agent =~ /.+(Android|iPhone).+/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1280: Invert condition</b></li>
</ul></details>
<span class=""> 1281: 			$self-&gt;{is_mobile} = 1;
</span><span class=""> 1282: 			return 1;
</span><span class=""> 1283: 		}
</span><span class=""> 1284: 
</span><span class=""> 1285: 		# From http://detectmobilebrowsers.com/
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1286: 		if($agent =~ m/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i || substr($ENV{&#39;HTTP_USER_AGENT&#39;}, 0, 4) =~ m/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1286: Invert condition</b></li>
</ul></details>
<span class=""> 1287: 			$self-&gt;{is_mobile} = 1;
</span><span class=""> 1288: 			return 1;
</span><span class=""> 1289: 		}
</span><span class=""> 1290: 
</span><span class=""> 1291: 		# Save loading and calling HTTP::BrowserDetect
</span><span class=""> 1292: 		my $remote = $ENV{&#39;REMOTE_ADDR&#39;};
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1293: 		if(defined($remote) &amp;&amp; $self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1293: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1294: 			if(my $type = $self-&gt;{cache}-&gt;get(&quot;$remote/$agent&quot;)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1294: Invert condition</b></li>
</ul></details>
<span class=""> 1295: 				return $self-&gt;{is_mobile} = ($type eq &#39;mobile&#39;);
</span><span class=""> 1296: 			}
</span><span class=""> 1297: 		}
</span><span class=""> 1298: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1299: 		unless($self-&gt;{browser_detect}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1299: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1300: 			if(eval { require HTTP::BrowserDetect; }) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1300: Invert condition</b></li>
</ul></details>
<span class=""> 1301: 				HTTP::BrowserDetect-&gt;import();
</span><span class=""> 1302: 				$self-&gt;{browser_detect} = HTTP::BrowserDetect-&gt;new($agent);
</span><span class=""> 1303: 			}
</span><span class=""> 1304: 		}
</span><span class=""> 1305: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1306: 		if($self-&gt;{browser_detect}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1306: Invert condition</b></li>
</ul></details>
<span class=""> 1307: 			my $device = $self-&gt;{browser_detect}-&gt;device();
</span><span class=""> 1308: 			# Without the ?1:0 it will set to the empty string not 0
</span><span class=""> 1309: 			my $is_mobile = (defined($device) &amp;&amp; ($device =~ /blackberry|webos|iphone|ipod|ipad|android/i)) ? 1 : 0;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1310: 			if($is_mobile &amp;&amp; $self-&gt;{cache} &amp;&amp; defined($remote)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1310: Invert condition</b></li>
</ul></details>
<span class=""> 1311: 				$self-&gt;{cache}-&gt;set(&quot;$remote/$agent&quot;, &#39;mobile&#39;, &#39;1 day&#39;);
</span><span class=""> 1312: 			}
</span><span class=""> 1313: 			return $self-&gt;{is_mobile} = $is_mobile;
</span><span class=""> 1314: 		}
</span><span class=""> 1315: 	}
</span><span class=""> 1316: 
</span><span class=""> 1317: 	return 0;
</span><span class=""> 1318: }
</span><span class=""> 1319: 
</span><span class=""> 1320: =head2 is_tablet
</span><span class=""> 1321: 
</span><span class=""> 1322: Returns a boolean if the website is being viewed on a tablet such as an iPad.
</span><span class=""> 1323: 
</span><span class=""> 1324: =cut
</span><span class=""> 1325: 
</span><span class=""> 1326: sub is_tablet {
</span><span class=""> 1327: 	my $self = shift;
</span><span class=""> 1328: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1329: 	if(defined($self-&gt;{is_tablet})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1329: Invert condition</b></li>
</ul></details>
<span class=""> 1330: 		return $self-&gt;{is_tablet};
</span><span class=""> 1331: 	}
</span><span class=""> 1332: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1333: 	if($ENV{&#39;HTTP_USER_AGENT&#39;} &amp;&amp; ($ENV{&#39;HTTP_USER_AGENT&#39;} =~ /.+(iPad|TabletPC).+/)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1333: Invert condition</b></li>
</ul></details>
<span class=""> 1334: 		# TODO: add others when I see some nice user_agents
</span><span class=""> 1335: 		$self-&gt;{is_tablet} = 1;
</span><span class=""> 1336: 	} else {
</span><span class=""> 1337: 		$self-&gt;{is_tablet} = 0;
</span><span class=""> 1338: 	}
</span><span class=""> 1339: 
</span><span class=""> 1340: 	return $self-&gt;{is_tablet};
</span><span class=""> 1341: }
</span><span class=""> 1342: 
</span><span class=""> 1343: =head2 as_string
</span><span class=""> 1344: 
</span><span class=""> 1345: Converts CGI parameters into a formatted string representation with optional raw mode (no escaping of special characters).
</span><span class=""> 1346: Useful for debugging or generating keys for a cache.
</span><span class=""> 1347: 
</span><span class=""> 1348:     my $string_representation = $info-&gt;as_string();
</span><span class=""> 1349:     my $raw_string = $info-&gt;as_string({ raw =&gt; 1 });
</span><span class=""> 1350: 
</span><span class=""> 1351: =head3 API SPECIFICATION
</span><span class=""> 1352: 
</span><span class=""> 1353: =head4 INPUT
</span><span class=""> 1354: 
</span><span class=""> 1355:   {
</span><span class=""> 1356:     raw =&gt; {
</span><span class=""> 1357:       &#39;type&#39; =&gt; &#39;boolean&#39;,
</span><span class=""> 1358:       &#39;optional&#39; =&gt; 1,
</span><span class=""> 1359:     }
</span><span class=""> 1360:   }
</span><span class=""> 1361: 
</span><span class=""> 1362: =head4 OUTPUT
</span><span class=""> 1363: 
</span><span class=""> 1364:   {
</span><span class=""> 1365:     type =&gt; &#39;string&#39;,
</span><span class=""> 1366:     optional =&gt; 1,
</span><span class=""> 1367:   }
</span><span class=""> 1368: 
</span><span class=""> 1369: =cut
</span><span class=""> 1370: 
</span><span class=""> 1371: sub as_string
</span><span class=""> 1372: {
</span><span class=""> 1373: 	my $self = shift;
</span><span class=""> 1374: 
</span><span class=""> 1375: 	my $args = Params::Validate::Strict::validate_strict({
</span><span class=""> 1376: 		args =&gt; Params::Get::get_params(undef, @_) || {},
</span><span class=""> 1377: 		schema =&gt; {
</span><span class=""> 1378: 			raw =&gt; {
</span><span class=""> 1379: 				&#39;type&#39; =&gt; &#39;boolean&#39;,
</span><span class=""> 1380: 				&#39;optional&#39; =&gt; 1
</span><span class=""> 1381: 			}
</span><span class=""> 1382: 		}
</span><span class=""> 1383: 	});
</span><span class=""> 1384: 
</span><span class=""> 1385: 	# Retrieve object parameters
</span><span class=""> 1386: 	my $params = $self-&gt;params() || return &#39;&#39;;
</span><span class=""> 1387: 
</span><span class=""> 1388: 	my $rc;
</span><span class=""> 1389: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1390: 	if($args-&gt;{&#39;raw&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1390: Invert condition</b></li>
</ul></details>
<span class=""> 1391: 		# Raw mode: return key=value pairs without escaping
</span><span class=""> 1392: 		$rc = join &#39;; &#39;, map {
</span><span class=""> 1393: 			&quot;$_=&quot; . $params-&gt;{$_}
</span><span class=""> 1394: 		} sort keys %{$params};
</span><span class=""> 1395: 	} else {
</span><span class=""> 1396: 		# Escaped mode: escape special characters
</span><span class=""> 1397: 		$rc = join &#39;; &#39;, map {
</span><span class=""> 1398: 			my $value = $params-&gt;{$_};
</span><span class=""> 1399: 
</span><span class=""> 1400: 			$value =~ s/\\/\\\\/g;	# Escape backslashes
</span><span class=""> 1401: 			$value =~ s/(;|=)/\\$1/g;	# Escape semicolons and equals signs
</span><span class=""> 1402: 			&quot;$_=$value&quot;
</span><span class=""> 1403: 		} sort keys %{$params};
</span><span class=""> 1404: 	}
</span><span class=""> 1405: 
</span><span class=""> 1406: 	$rc ||= &#39;&#39;;
</span><span class=""> 1407: 
</span><span class=""> 1408: 	$self-&gt;_trace(&quot;as_string: returning &#39;$rc&#39;&quot;);
</span><span class=""> 1409: 
</span><span class=""> 1410: 	return $rc;
</span><span class=""> 1411: }
</span><span class=""> 1412: 
</span><span class=""> 1413: =head2 protocol
</span><span class=""> 1414: 
</span><span class=""> 1415: Returns the connection protocol, presumably &#39;http&#39; or &#39;https&#39;, or undef if
</span><span class=""> 1416: it can&#39;t be determined.
</span><span class=""> 1417: 
</span><span class=""> 1418: =cut
</span><span class=""> 1419: 
</span><span class=""> 1420: sub protocol {
</span><span class=""> 1421: 	my $self = shift;
</span><span class=""> 1422: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1423: 	if($ENV{&#39;SCRIPT_URI&#39;} &amp;&amp; ($ENV{&#39;SCRIPT_URI&#39;} =~ /^(.+):\/\/.+/)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1423: Invert condition</b></li>
</ul></details>
<span class=""> 1424: 		return $1;
</span><span class=""> 1425: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1426: 	if($ENV{&#39;SERVER_PROTOCOL&#39;} &amp;&amp; ($ENV{&#39;SERVER_PROTOCOL&#39;} =~ /^HTTP\//)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1426: Invert condition</b></li>
</ul></details>
<span class=""> 1427: 		return &#39;http&#39;;
</span><span class=""> 1428: 	}
</span><span class=""> 1429: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1430: 	if(my $port = $ENV{&#39;SERVER_PORT&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1430: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1431: 		if(defined(my $name = getservbyport($port, &#39;tcp&#39;))) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1431: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1432: 			if($name =~ /https?/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1432: Invert condition</b></li>
</ul></details>
<span class=""> 1433: 				return $name;
</span><span class=""> 1434: 			} elsif($name eq &#39;www&#39;) {
</span><span class=""> 1435: 				# e.g. NetBSD and OpenBSD
</span><span class=""> 1436: 				return &#39;http&#39;;
</span><span class=""> 1437: 			}
</span><span class=""> 1438: 			# Return an error, maybe missing something
</span><span class="survived-1 tooltip" data-tooltip="Boundary mutation survived. Add tests around edge values (e.g. min, max, off-by-one)."> 1439: 		} elsif($port == 80) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 0, Survived: 1)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_1439: Numeric boundary flip == to !=</b></li>
</ul></details>
<span class=""> 1440: 			# e.g. Solaris
</span><span class=""> 1441: 			return &#39;http&#39;;
</span><span class="survived-1 tooltip" data-tooltip="Boundary mutation survived. Add tests around edge values (e.g. min, max, off-by-one)."> 1442: 		} elsif($port == 443) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 0, Survived: 1)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_1442: Numeric boundary flip == to !=</b></li>
</ul></details>
<span class=""> 1443: 			return &#39;https&#39;;
</span><span class=""> 1444: 		}
</span><span class=""> 1445: 	}
</span><span class=""> 1446: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1447: 	if($ENV{&#39;REMOTE_ADDR&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1447: Invert condition</b></li>
</ul></details>
<span class=""> 1448: 		$self-&gt;_warn(&quot;Can&#39;t determine the calling protocol&quot;);
</span><span class=""> 1449: 	}
</span><span class=""> 1450: 	return;
</span><span class=""> 1451: }
</span><span class=""> 1452: 
</span><span class=""> 1453: =head2 tmpdir
</span><span class=""> 1454: 
</span><span class=""> 1455: Returns the name of a directory that you can use to create temporary files
</span><span class=""> 1456: in.
</span><span class=""> 1457: 
</span><span class=""> 1458: The routine is preferable to L&lt;File::Spec/tmpdir&gt; since CGI programs are
</span><span class=""> 1459: often running on shared servers.  Having said that, tmpdir will fall back
</span><span class=""> 1460: to File::Spec-&gt;tmpdir() if it can&#39;t find somewhere better.
</span><span class=""> 1461: 
</span><span class=""> 1462: If the parameter &#39;default&#39; is given, then use that directory as a
</span><span class=""> 1463: fall-back rather than the value in File::Spec-&gt;tmpdir().
</span><span class=""> 1464: No sanity tests are done, so if you give the default value of
</span><span class=""> 1465: &#39;/non-existant&#39;, that will be returned.
</span><span class=""> 1466: 
</span><span class=""> 1467: Tmpdir allows a reference of the options to be passed.
</span><span class=""> 1468: 
</span><span class=""> 1469: 	use CGI::Info;
</span><span class=""> 1470: 
</span><span class=""> 1471: 	my $info = CGI::Info-&gt;new();
</span><span class=""> 1472: 	my $dir = $info-&gt;tmpdir(default =&gt; &#39;/var/tmp&#39;);
</span><span class=""> 1473: 	$dir = $info-&gt;tmpdir({ default =&gt; &#39;/var/tmp&#39; });
</span><span class=""> 1474: 
</span><span class=""> 1475: 	# or
</span><span class=""> 1476: 
</span><span class=""> 1477: 	my $dir = CGI::Info-&gt;tmpdir();
</span><span class=""> 1478: =cut
</span><span class=""> 1479: 
</span><span class=""> 1480: sub tmpdir {
</span><span class=""> 1481: 	my $self = shift;
</span><span class=""> 1482: 
</span><span class=""> 1483: 	my $name = &#39;tmp&#39;;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1484: 	if($^O eq &#39;MSWin32&#39;) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1484: Invert condition</b></li>
</ul></details>
<span class=""> 1485: 		$name = &#39;temp&#39;;
</span><span class=""> 1486: 	}
</span><span class=""> 1487: 
</span><span class=""> 1488: 	my $dir;
</span><span class=""> 1489: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1490: 	if(!ref($self)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1490: Invert condition</b></li>
</ul></details>
<span class=""> 1491: 		$self = __PACKAGE__-&gt;new();
</span><span class=""> 1492: 	}
</span><span class=""> 1493: 	my $params = Params::Get::get_params(undef, @_);
</span><span class=""> 1494: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1495: 	if($ENV{&#39;C_DOCUMENT_ROOT&#39;} &amp;&amp; (-d $ENV{&#39;C_DOCUMENT_ROOT&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1495: Invert condition</b></li>
</ul></details>
<span class=""> 1496: 		$dir = File::Spec-&gt;catdir($ENV{&#39;C_DOCUMENT_ROOT&#39;}, $name);
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1497: 		if((-d $dir) &amp;&amp; (-w $dir)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1497: Invert condition</b></li>
</ul></details>
<span class=""> 1498: 			return $self-&gt;_untaint_filename({ filename =&gt; $dir });
</span><span class=""> 1499: 		}
</span><span class=""> 1500: 		$dir = $ENV{&#39;C_DOCUMENT_ROOT&#39;};
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1501: 		if((-d $dir) &amp;&amp; (-w $dir)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1501: Invert condition</b></li>
</ul></details>
<span class=""> 1502: 			return $self-&gt;_untaint_filename({ filename =&gt; $dir });
</span><span class=""> 1503: 		}
</span><span class=""> 1504: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1505: 	if($ENV{&#39;DOCUMENT_ROOT&#39;} &amp;&amp; (-d $ENV{&#39;DOCUMENT_ROOT&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1505: Invert condition</b></li>
</ul></details>
<span class=""> 1506: 		$dir = File::Spec-&gt;catdir($ENV{&#39;DOCUMENT_ROOT&#39;}, File::Spec-&gt;updir(), $name);
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1507: 		if((-d $dir) &amp;&amp; (-w $dir)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1507: Invert condition</b></li>
</ul></details>
<span class=""> 1508: 			return $self-&gt;_untaint_filename({ filename =&gt; $dir });
</span><span class=""> 1509: 		}
</span><span class=""> 1510: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1511: 	if($params-&gt;{&#39;default&#39;} &amp;&amp; ref($params-&gt;{&#39;default&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1511: Invert condition</b></li>
</ul></details>
<span class=""> 1512: 		croak(ref($self), &#39;: tmpdir must be given a scalar&#39;);
</span><span class=""> 1513: 	}
</span><span class=""> 1514: 	return $params-&gt;{default} ? $params-&gt;{default} : File::Spec-&gt;tmpdir();
</span><span class=""> 1515: }
</span><span class=""> 1516: 
</span><span class=""> 1517: =head2 rootdir
</span><span class=""> 1518: 
</span><span class=""> 1519: Returns the document root.  This is preferable to looking at DOCUMENT_ROOT
</span><span class=""> 1520: in the environment because it will also work when we&#39;re not running as a CGI
</span><span class=""> 1521: script, which is useful for script debugging.
</span><span class=""> 1522: 
</span><span class=""> 1523: This can be run as a class or object method.
</span><span class=""> 1524: 
</span><span class=""> 1525: 	use CGI::Info;
</span><span class=""> 1526: 
</span><span class=""> 1527: 	print CGI::Info-&gt;rootdir();
</span><span class=""> 1528: 
</span><span class=""> 1529: =cut
</span><span class=""> 1530: 
</span><span class=""> 1531: sub rootdir {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1532: 	if($ENV{&#39;C_DOCUMENT_ROOT&#39;} &amp;&amp; (-d $ENV{&#39;C_DOCUMENT_ROOT&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1532: Invert condition</b></li>
</ul></details>
<span class=""> 1533: 		return $ENV{&#39;C_DOCUMENT_ROOT&#39;};
</span><span class=""> 1534: 	} elsif($ENV{&#39;DOCUMENT_ROOT&#39;} &amp;&amp; (-d $ENV{&#39;DOCUMENT_ROOT&#39;})) {
</span><span class=""> 1535: 		return $ENV{&#39;DOCUMENT_ROOT&#39;};
</span><span class=""> 1536: 	}
</span><span class=""> 1537: 	my $script_name = $0;
</span><span class=""> 1538: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1539: 	unless(File::Spec-&gt;file_name_is_absolute($script_name)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1539: Invert condition</b></li>
</ul></details>
<span class=""> 1540: 		$script_name = File::Spec-&gt;rel2abs($script_name);
</span><span class=""> 1541: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1542: 	if($script_name =~ /.cgi\-bin.*/) {	# kludge for outside CGI environment
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1542: Invert condition</b></li>
</ul></details>
<span class=""> 1543: 		$script_name =~ s/.cgi\-bin.*//;
</span><span class=""> 1544: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1545: 	if(-f $script_name) {	# More kludge
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1545: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1546: 		if($^O eq &#39;MSWin32&#39;) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1546: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1547: 			if($script_name =~ /(.+)\\.+?$/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1547: Invert condition</b></li>
</ul></details>
<span class=""> 1548: 				return $1;
</span><span class=""> 1549: 			}
</span><span class=""> 1550: 		} else {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1551: 			if($script_name =~ /(.+)\/.+?$/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1551: Invert condition</b></li>
</ul></details>
<span class=""> 1552: 				return $1;
</span><span class=""> 1553: 			}
</span><span class=""> 1554: 		}
</span><span class=""> 1555: 	}
</span><span class=""> 1556: 	return $script_name;
</span><span class=""> 1557: }
</span><span class=""> 1558: 
</span><span class=""> 1559: =head2 root_dir
</span><span class=""> 1560: 
</span><span class=""> 1561: Synonym of rootdir(), for compatibility with L&lt;CHI&gt;.
</span><span class=""> 1562: 
</span><span class=""> 1563: =cut
</span><span class=""> 1564: 
</span><span class=""> 1565: sub root_dir
</span><span class=""> 1566: {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1567: 	if($_[0] &amp;&amp; ref($_[0])) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1567: Invert condition</b></li>
</ul></details>
<span class=""> 1568: 		my $self = shift;
</span><span class=""> 1569: 
</span><span class=""> 1570: 		return $self-&gt;rootdir(@_);
</span><span class=""> 1571: 	}
</span><span class=""> 1572: 	return __PACKAGE__-&gt;rootdir(@_);
</span><span class=""> 1573: }
</span><span class=""> 1574: 
</span><span class=""> 1575: =head2 documentroot
</span><span class=""> 1576: 
</span><span class=""> 1577: Synonym of rootdir(), for compatibility with Apache.
</span><span class=""> 1578: 
</span><span class=""> 1579: =cut
</span><span class=""> 1580: 
</span><span class=""> 1581: sub documentroot
</span><span class=""> 1582: {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1583: 	if($_[0] &amp;&amp; ref($_[0])) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1583: Invert condition</b></li>
</ul></details>
<span class=""> 1584: 		my $self = shift;
</span><span class=""> 1585: 
</span><span class=""> 1586: 		return $self-&gt;rootdir(@_);
</span><span class=""> 1587: 	}
</span><span class=""> 1588: 	return __PACKAGE__-&gt;rootdir(@_);
</span><span class=""> 1589: }
</span><span class=""> 1590: 
</span><span class=""> 1591: =head2 logdir($dir)
</span><span class=""> 1592: 
</span><span class=""> 1593: Gets and sets the name of a directory where you can store logs.
</span><span class=""> 1594: 
</span><span class=""> 1595: =over 4
</span><span class=""> 1596: 
</span><span class=""> 1597: =item $dir
</span><span class=""> 1598: 
</span><span class=""> 1599: Path to the directory where logs will be stored.
</span><span class=""> 1600: 
</span><span class=""> 1601: =back
</span><span class=""> 1602: 
</span><span class=""> 1603: =cut
</span><span class=""> 1604: 
</span><span class=""> 1605: sub logdir {
</span><span class=""> 1606: 	my $self = shift;
</span><span class=""> 1607: 	my $dir = shift;
</span><span class=""> 1608: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1609: 	if(!ref($self)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1609: Invert condition</b></li>
</ul></details>
<span class=""> 1610: 		$self = __PACKAGE__-&gt;new();
</span><span class=""> 1611: 	}
</span><span class=""> 1612: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1613: 	if($dir) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1613: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1614: 		if(length($dir) &amp;&amp; (-d $dir) &amp;&amp; (-w $dir)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1614: Invert condition</b></li>
</ul></details>
<span class=""> 1615: 			return $self-&gt;{&#39;logdir&#39;} = $dir;
</span><span class=""> 1616: 		}
</span><span class=""> 1617: 		$self-&gt;_warn(&quot;Invalid logdir: $dir&quot;);
</span><span class=""> 1618: 		Carp::croak(&quot;Invalid logdir: $dir&quot;);
</span><span class=""> 1619: 	}
</span><span class=""> 1620: 
</span><span class=""> 1621: 	foreach my $rc($self-&gt;{logdir}, $ENV{&#39;LOGDIR&#39;}, Sys::Path-&gt;logdir(), $self-&gt;tmpdir()) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1622: 		if(defined($rc) &amp;&amp; length($rc) &amp;&amp; (-d $rc) &amp;&amp; (-w $rc)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1622: Invert condition</b></li>
</ul></details>
<span class=""> 1623: 			$dir = $rc;
</span><span class=""> 1624: 			last;
</span><span class=""> 1625: 		}
</span><span class=""> 1626: 	}
</span><span class="survived-1 tooltip" data-tooltip="Boundary mutation survived. Add tests around edge values (e.g. min, max, off-by-one)."> 1627: 	$self-&gt;_warn(&quot;Can&#39;t determine logdir&quot;) if((!defined($dir)) || (length($dir) == 0));
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 0, Survived: 1)</summary>
				<ul>
			<li><b>NUM_BOUNDARY_1627: Numeric boundary flip == to !=</b></li>
</ul></details>
<span class=""> 1628: 	$self-&gt;{logdir} ||= $dir;
</span><span class=""> 1629: 
</span><span class=""> 1630: 	return $dir;
</span><span class=""> 1631: }
</span><span class=""> 1632: 
</span><span class=""> 1633: =head2 is_robot
</span><span class=""> 1634: 
</span><span class=""> 1635: Is the visitor a real person or a robot?
</span><span class=""> 1636: 
</span><span class=""> 1637: 	use CGI::Info;
</span><span class=""> 1638: 
</span><span class=""> 1639: 	my $info = CGI::Info-&gt;new();
</span><span class=""> 1640: 	unless($info-&gt;is_robot()) {
</span><span class=""> 1641: 		# update site visitor statistics
</span><span class=""> 1642: 	}
</span><span class=""> 1643: 
</span><span class=""> 1644: If the client is seen to be attempting an SQL injection,
</span><span class=""> 1645: set the HTTP status to 403,
</span><span class=""> 1646: and return 1.
</span><span class=""> 1647: 
</span><span class=""> 1648: =cut
</span><span class=""> 1649: 
</span><span class=""> 1650: sub is_robot {
</span><span class=""> 1651: 	my $self = shift;
</span><span class=""> 1652: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1653: 	if(defined($self-&gt;{is_robot})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1653: Invert condition</b></li>
</ul></details>
<span class=""> 1654: 		return $self-&gt;{is_robot};
</span><span class=""> 1655: 	}
</span><span class=""> 1656: 
</span><span class=""> 1657: 	my $agent = $ENV{&#39;HTTP_USER_AGENT&#39;};
</span><span class=""> 1658: 	my $remote = $ENV{&#39;REMOTE_ADDR&#39;};
</span><span class=""> 1659: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1660: 	unless($remote &amp;&amp; $agent) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1660: Invert condition</b></li>
</ul></details>
<span class=""> 1661: 		# Probably not running in CGI - assume real person
</span><span class=""> 1662: 		return 0;
</span><span class=""> 1663: 	}
</span><span class=""> 1664: 
</span><span class=""> 1665: 	# See also params()
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1666: 	if(($agent =~ /SELECT.+AND.+/) || ($agent =~ /ORDER BY /) || ($agent =~ / OR NOT /) || ($agent =~ / AND \d+=\d+/) || ($agent =~ /THEN.+ELSE.+END/) || ($agent =~ /.+AND.+SELECT.+/) || ($agent =~ /\sAND\s.+\sAND\s/)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1666: Invert condition</b></li>
</ul></details>
<span class=""> 1667: 		$self-&gt;status(403);
</span><span class=""> 1668: 		$self-&gt;{is_robot} = 1;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1669: 		if($ENV{&#39;REMOTE_ADDR&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1669: Invert condition</b></li>
</ul></details>
<span class=""> 1670: 			$self-&gt;_warn($ENV{&#39;REMOTE_ADDR&#39;} . &quot;: SQL injection attempt blocked for &#39;$agent&#39;&quot;);
</span><span class=""> 1671: 		} else {
</span><span class=""> 1672: 			$self-&gt;_warn(&quot;SQL injection attempt blocked for &#39;$agent&#39;&quot;);
</span><span class=""> 1673: 		}
</span><span class=""> 1674: 		return 1;
</span><span class=""> 1675: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1676: 	if($agent =~ /.+bot|axios\/1\.6\.7|bidswitchbot|bytespider|ClaudeBot|Clickagy.Intelligence.Bot|msnptc|CriteoBot|is_archiver|backstreet|fuzz faster|linkfluence\.com|spider|scoutjet|gingersoftware|heritrix|dodnetdotcom|yandex|nutch|ezooms|plukkie|nova\.6scan\.com|Twitterbot|adscanner|Go-http-client|python-requests|Mediatoolkitbot|NetcraftSurveyAgent|Expanse|serpstatbot|DreamHost SiteMonitor|techiaith.cymru|trendictionbot|ias_crawler|WPsec|Yak\/1\.0|ZoominfoBot/i) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1676: Invert condition</b></li>
</ul></details>
<span class=""> 1677: 		$self-&gt;{is_robot} = 1;
</span><span class=""> 1678: 		return 1;
</span><span class=""> 1679: 	}
</span><span class=""> 1680: 
</span><span class=""> 1681: 	# TODO:
</span><span class=""> 1682: 	# Download and use list from
</span><span class=""> 1683: 	#	https://raw.githubusercontent.com/mitchellkrogza/apache-ultimate-bad-bot-blocker/refs/heads/master/_generator_lists/bad-user-agents.list
</span><span class=""> 1684: 
</span><span class=""> 1685: 	my $key = &quot;$remote/$agent&quot;;
</span><span class=""> 1686: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1687: 	if(my $referrer = $ENV{&#39;HTTP_REFERER&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1687: Invert condition</b></li>
</ul></details>
<span class=""> 1688: 		# https://agency.ohow.co/google-analytics-implementation-audit/google-analytics-historical-spam-list/
</span><span class=""> 1689: 		my @crawler_lists = (
</span><span class=""> 1690: 			&#39;http://fix-website-errors.com&#39;,
</span><span class=""> 1691: 			&#39;http://keywords-monitoring-your-success.com&#39;,
</span><span class=""> 1692: 			&#39;http://free-video-tool.com&#39;,
</span><span class=""> 1693: 			&#39;http://magnet-to-torrent.com&#39;,
</span><span class=""> 1694: 			&#39;http://torrent-to-magnet.com&#39;,
</span><span class=""> 1695: 			&#39;http://dogsrun.net&#39;,
</span><span class=""> 1696: 			&#39;http://###.responsive-test.net&#39;,
</span><span class=""> 1697: 			&#39;http://uptime.com&#39;,
</span><span class=""> 1698: 			&#39;http://uptimechecker.com&#39;,
</span><span class=""> 1699: 			&#39;http://top1-seo-service.com&#39;,
</span><span class=""> 1700: 			&#39;http://fast-wordpress-start.com&#39;,
</span><span class=""> 1701: 			&#39;http://wordpress-crew.net&#39;,
</span><span class=""> 1702: 			&#39;http://dbutton.net&#39;,
</span><span class=""> 1703: 			&#39;http://justprofit.xyz&#39;,
</span><span class=""> 1704: 			&#39;http://video--production.com&#39;,
</span><span class=""> 1705: 			&#39;http://buttons-for-website.com&#39;,
</span><span class=""> 1706: 			&#39;http://buttons-for-your-website.com&#39;,
</span><span class=""> 1707: 			&#39;http://success-seo.com&#39;,
</span><span class=""> 1708: 			&#39;http://videos-for-your-business.com&#39;,
</span><span class=""> 1709: 			&#39;http://semaltmedia.com&#39;,
</span><span class=""> 1710: 			&#39;http://dailyrank.net&#39;,
</span><span class=""> 1711: 			&#39;http://uptimebot.net&#39;,
</span><span class=""> 1712: 			&#39;http://sitevaluation.org&#39;,
</span><span class=""> 1713: 			&#39;http://100dollars-seo.com&#39;,
</span><span class=""> 1714: 			&#39;http://forum69.info&#39;,
</span><span class=""> 1715: 			&#39;http://partner.semalt.com&#39;,
</span><span class=""> 1716: 			&#39;http://best-seo-offer.com&#39;,
</span><span class=""> 1717: 			&#39;http://best-seo-solution.com&#39;,
</span><span class=""> 1718: 			&#39;http://semalt.semalt.com&#39;,
</span><span class=""> 1719: 			&#39;http://semalt.com&#39;,
</span><span class=""> 1720: 			&#39;http://7makemoneyonline.com&#39;,
</span><span class=""> 1721: 			&#39;http://anticrawler.org&#39;,
</span><span class=""> 1722: 			&#39;http://baixar-musicas-gratis.com&#39;,
</span><span class=""> 1723: 			&#39;http://descargar-musica-gratis.net&#39;,
</span><span class=""> 1724: 
</span><span class=""> 1725: 			# Mine
</span><span class=""> 1726: 			&#39;http://www.seokicks.de/robot.html&#39;,
</span><span class=""> 1727: 		);
</span><span class=""> 1728: 		$referrer =~ s/\\/_/g;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1729: 		if(($referrer =~ /\)/) || (List::Util::any { $_ =~ /^$referrer/ } @crawler_lists)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1729: Invert condition</b></li>
</ul></details>
<span class=""> 1730: 			$self-&gt;_debug(&quot;is_robot: blocked trawler $referrer&quot;);
</span><span class=""> 1731: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1732: 			if($self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1732: Invert condition</b></li>
</ul></details>
<span class=""> 1733: 				$self-&gt;{cache}-&gt;set($key, &#39;robot&#39;, &#39;1 day&#39;);
</span><span class=""> 1734: 			}
</span><span class=""> 1735: 			$self-&gt;{is_robot} = 1;
</span><span class=""> 1736: 			return 1;
</span><span class=""> 1737: 		}
</span><span class=""> 1738: 	}
</span><span class=""> 1739: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1740: 	if(defined($remote) &amp;&amp; $self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1740: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1741: 		if(my $type = $self-&gt;{cache}-&gt;get(&quot;$remote/$agent&quot;)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1741: Invert condition</b></li>
</ul></details>
<span class=""> 1742: 			return $self-&gt;{is_robot} = ($type eq &#39;robot&#39;);
</span><span class=""> 1743: 		}
</span><span class=""> 1744: 	}
</span><span class=""> 1745: 
</span><span class=""> 1746: 	# Don&#39;t use HTTP_USER_AGENT to detect more than we really have to since
</span><span class=""> 1747: 	# that is easily spoofed
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1748: 	if($agent =~ /www\.majestic12\.co\.uk|facebookexternal/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1748: Invert condition</b></li>
</ul></details>
<span class=""> 1749: 		# Mark Facebook as a search engine, not a robot
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1750: 		if($self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1750: Invert condition</b></li>
</ul></details>
<span class=""> 1751: 			$self-&gt;{cache}-&gt;set($key, &#39;search&#39;, &#39;1 day&#39;);
</span><span class=""> 1752: 		}
</span><span class=""> 1753: 		return 0;
</span><span class=""> 1754: 	}
</span><span class=""> 1755: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1756: 	unless($self-&gt;{browser_detect}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1756: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1757: 		if(eval { require HTTP::BrowserDetect; }) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1757: Invert condition</b></li>
</ul></details>
<span class=""> 1758: 			HTTP::BrowserDetect-&gt;import();
</span><span class=""> 1759: 			$self-&gt;{browser_detect} = HTTP::BrowserDetect-&gt;new($agent);
</span><span class=""> 1760: 		}
</span><span class=""> 1761: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1762: 	if($self-&gt;{browser_detect}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1762: Invert condition</b></li>
</ul></details>
<span class=""> 1763: 		my $is_robot = $self-&gt;{browser_detect}-&gt;robot();
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1764: 		if(defined($is_robot)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1764: Invert condition</b></li>
</ul></details>
<span class=""> 1765: 			$self-&gt;_debug(&quot;HTTP::BrowserDetect &#39;$ENV{HTTP_USER_AGENT}&#39; returns $is_robot&quot;);
</span><span class=""> 1766: 		}
</span><span class=""> 1767: 		$is_robot = (defined($is_robot) &amp;&amp; ($is_robot)) ? 1 : 0;
</span><span class=""> 1768: 		$self-&gt;_debug(&quot;is_robot: $is_robot&quot;);
</span><span class=""> 1769: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1770: 		if($is_robot) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1770: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1771: 			if($self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1771: Invert condition</b></li>
</ul></details>
<span class=""> 1772: 				$self-&gt;{cache}-&gt;set($key, &#39;robot&#39;, &#39;1 day&#39;);
</span><span class=""> 1773: 			}
</span><span class=""> 1774: 			$self-&gt;{is_robot} = $is_robot;
</span><span class=""> 1775: 			return $is_robot;
</span><span class=""> 1776: 		}
</span><span class=""> 1777: 	}
</span><span class=""> 1778: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1779: 	if($self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1779: Invert condition</b></li>
</ul></details>
<span class=""> 1780: 		$self-&gt;{cache}-&gt;set($key, &#39;unknown&#39;, &#39;1 day&#39;);
</span><span class=""> 1781: 	}
</span><span class=""> 1782: 	$self-&gt;{is_robot} = 0;
</span><span class=""> 1783: 	return 0;
</span><span class=""> 1784: }
</span><span class=""> 1785: 
</span><span class=""> 1786: =head2 is_search_engine
</span><span class=""> 1787: 
</span><span class=""> 1788: Is the visitor a search engine?
</span><span class=""> 1789: 
</span><span class=""> 1790:     if(CGI::Info-&gt;new()-&gt;is_search_engine()) {
</span><span class=""> 1791: 	# display generic information about yourself
</span><span class=""> 1792:     } else {
</span><span class=""> 1793: 	# allow the user to pick and choose something to display
</span><span class=""> 1794:     }
</span><span class=""> 1795: 
</span><span class=""> 1796: Can be overriden by the IS_SEARCH_ENGINE environment setting
</span><span class=""> 1797: 
</span><span class=""> 1798: =cut
</span><span class=""> 1799: 
</span><span class=""> 1800: sub is_search_engine
</span><span class=""> 1801: {
</span><span class=""> 1802: 	my $self = shift;
</span><span class=""> 1803: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1804: 	if(defined($self-&gt;{is_search_engine})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1804: Invert condition</b></li>
</ul></details>
<span class=""> 1805: 		return $self-&gt;{is_search_engine};
</span><span class=""> 1806: 	}
</span><span class=""> 1807: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1808: 	if($ENV{&#39;IS_SEARCH_ENGINE&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1808: Invert condition</b></li>
</ul></details>
<span class=""> 1809: 		return $ENV{&#39;IS_SEARCH_ENGINE&#39;}
</span><span class=""> 1810: 	}
</span><span class=""> 1811: 
</span><span class=""> 1812: 	my $remote = $ENV{&#39;REMOTE_ADDR&#39;};
</span><span class=""> 1813: 	my $agent = $ENV{&#39;HTTP_USER_AGENT&#39;};
</span><span class=""> 1814: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1815: 	unless($remote &amp;&amp; $agent) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1815: Invert condition</b></li>
</ul></details>
<span class=""> 1816: 		# Probably not running in CGI - assume not a search engine
</span><span class=""> 1817: 		return 0;
</span><span class=""> 1818: 	}
</span><span class=""> 1819: 
</span><span class=""> 1820: 	my $key;
</span><span class=""> 1821: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1822: 	if($self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1822: Invert condition</b></li>
</ul></details>
<span class=""> 1823: 		$key = &quot;$remote/$agent&quot;;
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1824: 		if(defined($remote) &amp;&amp; $self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1824: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1825: 			if(my $type = $self-&gt;{cache}-&gt;get(&quot;$remote/$agent&quot;)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1825: Invert condition</b></li>
</ul></details>
<span class=""> 1826: 				return $self-&gt;{is_search} = ($type eq &#39;search&#39;);
</span><span class=""> 1827: 			}
</span><span class=""> 1828: 		}
</span><span class=""> 1829: 	}
</span><span class=""> 1830: 
</span><span class=""> 1831: 	# Don&#39;t use HTTP_USER_AGENT to detect more than we really have to since
</span><span class=""> 1832: 	# that is easily spoofed
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1833: 	if($agent =~ /www\.majestic12\.co\.uk|facebookexternal/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1833: Invert condition</b></li>
</ul></details>
<span class=""> 1834: 		# Mark Facebook as a search engine, not a robot
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1835: 		if($self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1835: Invert condition</b></li>
</ul></details>
<span class=""> 1836: 			$self-&gt;{cache}-&gt;set($key, &#39;search&#39;, &#39;1 day&#39;);
</span><span class=""> 1837: 		}
</span><span class=""> 1838: 		return 1;
</span><span class=""> 1839: 	}
</span><span class=""> 1840: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1841: 	unless($self-&gt;{browser_detect}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1841: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1842: 		if(eval { require HTTP::BrowserDetect; }) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1842: Invert condition</b></li>
</ul></details>
<span class=""> 1843: 			HTTP::BrowserDetect-&gt;import();
</span><span class=""> 1844: 			$self-&gt;{browser_detect} = HTTP::BrowserDetect-&gt;new($agent);
</span><span class=""> 1845: 		}
</span><span class=""> 1846: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1847: 	if(my $browser = $self-&gt;{browser_detect}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1847: Invert condition</b></li>
</ul></details>
<span class=""> 1848: 		my $is_search = ($browser-&gt;google() || $browser-&gt;msn() || $browser-&gt;baidu() || $browser-&gt;altavista() || $browser-&gt;yahoo() || $browser-&gt;bingbot());
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1849: 		if(!$is_search) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1849: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1850: 			if(($agent =~ /SeznamBot\//) ||
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1850: Invert condition</b></li>
</ul></details>
<span class=""> 1851: 			   ($agent =~ /Google-InspectionTool\//) ||
</span><span class=""> 1852: 			   ($agent =~ /Googlebot\//)) {
</span><span class=""> 1853: 				$is_search = 1;
</span><span class=""> 1854: 			}
</span><span class=""> 1855: 		}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1856: 		if($is_search &amp;&amp; $self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1856: Invert condition</b></li>
</ul></details>
<span class=""> 1857: 			$self-&gt;{cache}-&gt;set($key, &#39;search&#39;, &#39;1 day&#39;);
</span><span class=""> 1858: 		}
</span><span class=""> 1859: 		return $self-&gt;{is_search_engine} = $is_search;
</span><span class=""> 1860: 	}
</span><span class=""> 1861: 
</span><span class=""> 1862: 	# TODO: DNS lookup, not gethostbyaddr - though that will be slow
</span><span class=""> 1863: 	my $hostname = gethostbyaddr(inet_aton($remote), AF_INET) || $remote;
</span><span class=""> 1864: 
</span><span class=""> 1865: 	my @cidr_blocks = (&#39;47.235.0.0/12&#39;);	# Alibaba
</span><span class=""> 1866: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1867: 	if((defined($hostname) &amp;&amp; ($hostname =~ /google|msnbot|bingbot|amazonbot|GPTBot/) &amp;&amp; ($hostname !~ /^google-proxy/)) ||
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1867: Invert condition</b></li>
</ul></details>
<span class=""> 1868: 	   (Net::CIDR::cidrlookup($remote, @cidr_blocks))) {
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1869: 		if($self-&gt;{cache}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1869: Invert condition</b></li>
</ul></details>
<span class=""> 1870: 			$self-&gt;{cache}-&gt;set($key, &#39;search&#39;, &#39;1 day&#39;);
</span><span class=""> 1871: 		}
</span><span class=""> 1872: 		$self-&gt;{is_search_engine} = 1;
</span><span class=""> 1873: 		return 1;
</span><span class=""> 1874: 	}
</span><span class=""> 1875: 
</span><span class=""> 1876: 	$self-&gt;{is_search_engine} = 0;
</span><span class=""> 1877: 	return 0;
</span><span class=""> 1878: }
</span><span class=""> 1879: 
</span><span class=""> 1880: =head2 browser_type
</span><span class=""> 1881: 
</span><span class=""> 1882: Returns one of &#39;web&#39;, &#39;search&#39;, &#39;robot&#39; and &#39;mobile&#39;.
</span><span class=""> 1883: 
</span><span class=""> 1884:     # Code to display a different web page for a browser, search engine and
</span><span class=""> 1885:     # smartphone
</span><span class=""> 1886:     use Template;
</span><span class=""> 1887:     use CGI::Info;
</span><span class=""> 1888: 
</span><span class=""> 1889:     my $info = CGI::Info-&gt;new();
</span><span class=""> 1890:     my $dir = $info-&gt;rootdir() . &#39;/templates/&#39; . $info-&gt;browser_type();
</span><span class=""> 1891: 
</span><span class=""> 1892:     my $filename = ref($self);
</span><span class=""> 1893:     $filename =~ s/::/\//g;
</span><span class=""> 1894:     $filename = &quot;$dir/$filename.tmpl&quot;;
</span><span class=""> 1895: 
</span><span class=""> 1896:     if((!-f $filename) || (!-r $filename)) {
</span><span class=""> 1897: 	die &quot;Can&#39;t open $filename&quot;;
</span><span class=""> 1898:     }
</span><span class=""> 1899:     my $template = Template-&gt;new();
</span><span class=""> 1900:     $template-&gt;process($filename, {}) || die $template-&gt;error();
</span><span class=""> 1901: 
</span><span class=""> 1902: =cut
</span><span class=""> 1903: 
</span><span class=""> 1904: sub browser_type {
</span><span class=""> 1905: 	my $self = shift;
</span><span class=""> 1906: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1907: 	if($self-&gt;is_mobile()) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1907: Invert condition</b></li>
</ul></details>
<span class=""> 1908: 		return &#39;mobile&#39;;
</span><span class=""> 1909: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1910: 	if($self-&gt;is_search_engine()) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1910: Invert condition</b></li>
</ul></details>
<span class=""> 1911: 		return &#39;search&#39;;
</span><span class=""> 1912: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 1913: 	if($self-&gt;is_robot()) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_1913: Invert condition</b></li>
</ul></details>
<span class=""> 1914: 		return &#39;robot&#39;;
</span><span class=""> 1915: 	}
</span><span class=""> 1916: 	return &#39;web&#39;;
</span><span class=""> 1917: }
</span><span class=""> 1918: 
</span><span class=""> 1919: =head2 get_cookie
</span><span class=""> 1920: 
</span><span class=""> 1921: Returns a cookie&#39;s value, or undef if no name is given, or the requested
</span><span class=""> 1922: cookie isn&#39;t in the jar.
</span><span class=""> 1923: 
</span><span class=""> 1924: Deprecated - use cookie() instead.
</span><span class=""> 1925: 
</span><span class=""> 1926:     use CGI::Info;
</span><span class=""> 1927: 
</span><span class=""> 1928:     my $i = CGI::Info-&gt;new();
</span><span class=""> 1929:     my $name = $i-&gt;get_cookie(cookie_name =&gt; &#39;name&#39;);
</span><span class=""> 1930:     print &quot;Your name is $name\n&quot;;
</span><span class=""> 1931:     my $address = $i-&gt;get_cookie(&#39;address&#39;);
</span><span class=""> 1932:     print &quot;Your address is $address\n&quot;;
</span><span class=""> 1933: 
</span><span class=""> 1934: =cut
</span><span class=""> 1935: 
</span><span class=""> 1936: sub get_cookie {
</span><span class=""> 1937: 	my $self = shift;
</span><span class=""> 1938: 
</span><span class=""> 1939: 	return $self-&gt;cookie(\@_);
</span><span class=""> 1940: }
</span><span class=""> 1941: 
</span><span class=""> 1942: =head2 cookie
</span><span class=""> 1943: 
</span><span class=""> 1944: Returns a cookie&#39;s value, or undef if no name is given, or the requested
</span><span class=""> 1945: cookie isn&#39;t in the jar.
</span><span class=""> 1946: API is the same as &quot;param&quot;,
</span><span class=""> 1947: it will replace the &quot;get_cookie&quot; method in the future.
</span><span class=""> 1948: 
</span><span class=""> 1949:     use CGI::Info;
</span><span class=""> 1950: 
</span><span class=""> 1951:     my $name = CGI::Info-&gt;new()-&gt;cookie(&#39;name&#39;);
</span><span class=""> 1952:     print &quot;Your name is $name\n&quot;;
</span><span class=""> 1953: 
</span><span class=""> 1954: 
</span><span class=""> 1955: =head3 API SPECIFICATION
</span><span class=""> 1956: 
</span><span class=""> 1957: =head4 INPUT
</span><span class=""> 1958: 
</span><span class=""> 1959:   {
</span><span class=""> 1960:     cookie_name =&gt; {
</span><span class=""> 1961:       &#39;type&#39; =&gt; &#39;string&#39;,
</span><span class=""> 1962:       &#39;min&#39; =&gt; 1,
</span><span class=""> 1963:       &#39;matches&#39; =&gt; qr/^[!#-&#39;*+\-.\^_`|~0-9A-Za-z]+$/	# RFC6265
</span><span class=""> 1964:     }
</span><span class=""> 1965:   }
</span><span class=""> 1966: 
</span><span class=""> 1967: =head4 OUTPUT
</span><span class=""> 1968: 
</span><span class=""> 1969: Cookie not set: C&lt;undef&gt;
</span><span class=""> 1970: 
</span><span class=""> 1971: Cookie set:
</span><span class=""> 1972: 
</span><span class=""> 1973:   {
</span><span class=""> 1974:     type =&gt; &#39;string&#39;,
</span><span class=""> 1975:     optional =&gt; 1,
</span><span class=""> 1976:     matches =&gt; qr/	# RFC6265
</span><span class=""> 1977:       ^
</span><span class=""> 1978:       (?:
</span><span class=""> 1979:         &quot;[\x21\x23-\x2B\x2D-\x3A\x3C-\x5B\x5D-\x7E]*&quot;   # quoted
</span><span class=""> 1980:       | [\x21\x23-\x2B\x2D-\x3A\x3C-\x5B\x5D-\x7E]*     # unquoted
</span><span class=""> 1981:       )
</span><span class=""> 1982:       $
</span><span class=""> 1983:     /x
</span><span class=""> 1984:   }
</span><span class=""> 1985: 
</span><span class=""> 1986: =cut
</span><span class=""> 1987: 
</span><span class=""> 1988: sub cookie
</span><span class=""> 1989: {
</span><span class=""> 1990: 	my $self = shift;
</span><span class=""> 1991: 	my $params = Params::Validate::Strict::validate_strict({
</span><span class=""> 1992: 		args =&gt; Params::Get::get_params(&#39;cookie_name&#39;, @_),
</span><span class=""> 1993: 		schema =&gt; {
</span><span class=""> 1994: 			cookie_name =&gt; {
</span><span class=""> 1995: 				&#39;type&#39; =&gt; &#39;string&#39;,
</span><span class=""> 1996: 				&#39;min&#39; =&gt; 1,
</span><span class=""> 1997: 				&#39;matches&#39; =&gt; qr/^[!#-&#39;*+\-.\^_`|~0-9A-Za-z]+$/	# RFC6265
</span><span class=""> 1998: 			}
</span><span class=""> 1999: 		}
</span><span class=""> 2000: 	});
</span><span class=""> 2001: 
</span><span class=""> 2002: 	my $field = $params-&gt;{&#39;cookie_name&#39;};
</span><span class=""> 2003: 
</span><span class=""> 2004: 	# Validate field argument
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2005: 	if(!defined($field)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2005: Invert condition</b></li>
</ul></details>
<span class=""> 2006: 		$self-&gt;_error(&#39;what cookie do you want?&#39;);
</span><span class=""> 2007: 		Carp::croak(&#39;what cookie do you want?&#39;);
</span><span class=""> 2008: 		return;
</span><span class=""> 2009: 	}
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2010: 	if(ref($field)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2010: Invert condition</b></li>
</ul></details>
<span class=""> 2011: 		$self-&gt;_error(&#39;Cookie name should be a string&#39;);
</span><span class=""> 2012: 		Carp::croak(&#39;Cookie name should be a string&#39;);
</span><span class=""> 2013: 		return;
</span><span class=""> 2014: 	}
</span><span class=""> 2015: 
</span><span class=""> 2016: 	# Load cookies if not already loaded
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2017: 	unless($self-&gt;{jar}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2017: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2018: 		if(defined $ENV{&#39;HTTP_COOKIE&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2018: Invert condition</b></li>
</ul></details>
<span class=""> 2019: 			$self-&gt;{jar} = { map { split(/=/, $_, 2) } split(/; /, $ENV{&#39;HTTP_COOKIE&#39;}) };
</span><span class=""> 2020: 		}
</span><span class=""> 2021: 	}
</span><span class=""> 2022: 
</span><span class=""> 2023: 	# Return the cookie value if it exists, otherwise return undef
</span><span class=""> 2024: 	return $self-&gt;{jar}{$field};
</span><span class=""> 2025: }
</span><span class=""> 2026: 
</span><span class=""> 2027: =head2 status($status)
</span><span class=""> 2028: 
</span><span class=""> 2029: Sets or returns the status of the object,
</span><span class=""> 2030: 200 for OK,
</span><span class=""> 2031: otherwise an HTTP error code
</span><span class=""> 2032: 
</span><span class=""> 2033: =over 4
</span><span class=""> 2034: 
</span><span class=""> 2035: =item $status
</span><span class=""> 2036: 
</span><span class=""> 2037: Optional integer value to be set or retrieved.
</span><span class=""> 2038: If omitted, the value is retrieved.
</span><span class=""> 2039: 
</span><span class=""> 2040: =back
</span><span class=""> 2041: 
</span><span class=""> 2042: =cut
</span><span class=""> 2043: 
</span><span class=""> 2044: sub status
</span><span class=""> 2045: {
</span><span class=""> 2046: 	my $self = shift;
</span><span class=""> 2047: 	my $status = shift;
</span><span class=""> 2048: 
</span><span class=""> 2049: 	# Set status if provided
</span><span class=""> 2050: 	return $self-&gt;{status} = $status if(defined($status));
</span><span class=""> 2051: 
</span><span class=""> 2052: 	# Determine status based on request method if status is not set
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2053: 	unless (defined $self-&gt;{status}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2053: Invert condition</b></li>
</ul></details>
<span class=""> 2054: 		my $method = $ENV{&#39;REQUEST_METHOD&#39;};
</span><span class=""> 2055: 
</span><span class=""> 2056: 		return 405 if $method &amp;&amp; ($method eq &#39;OPTIONS&#39; || $method eq &#39;DELETE&#39;);
</span><span class=""> 2057: 		return 411 if $method &amp;&amp; ($method eq &#39;POST&#39; &amp;&amp; !defined $ENV{&#39;CONTENT_LENGTH&#39;});
</span><span class=""> 2058: 
</span><span class=""> 2059: 		return 200;
</span><span class=""> 2060: 	}
</span><span class=""> 2061: 
</span><span class=""> 2062: 	# Return current status or 200 by default
</span><span class=""> 2063: 	return $self-&gt;{status} || 200;
</span><span class=""> 2064: }
</span><span class=""> 2065: 
</span><span class=""> 2066: =head2 messages
</span><span class=""> 2067: 
</span><span class=""> 2068: Returns the messages that the object has generated as a ref to an array of hashes.
</span><span class=""> 2069: 
</span><span class=""> 2070:     my @messages;
</span><span class=""> 2071:     if(my $w = $info-&gt;messages()) {
</span><span class=""> 2072:         @messages = map { $_-&gt;{&#39;message&#39;} } @{$w};
</span><span class=""> 2073:     } else {
</span><span class=""> 2074:         @messages = ();
</span><span class=""> 2075:     }
</span><span class=""> 2076:     print STDERR join(&#39;;&#39;, @messages), &quot;\n&quot;;
</span><span class=""> 2077: 
</span><span class=""> 2078: =cut
</span><span class=""> 2079: 
</span><span class=""> 2080: sub messages
</span><span class=""> 2081: {
</span><span class=""> 2082: 	my $self = shift;
</span><span class=""> 2083: 
</span><span class=""> 2084: 	return $self-&gt;{&#39;messages&#39;};
</span><span class=""> 2085: }
</span><span class=""> 2086: 
</span><span class=""> 2087: =head2	messages_as_string
</span><span class=""> 2088: 
</span><span class=""> 2089: Returns the messages of that the object has generated as a string.
</span><span class=""> 2090: 
</span><span class=""> 2091: =cut
</span><span class=""> 2092: 
</span><span class=""> 2093: sub messages_as_string
</span><span class=""> 2094: {
</span><span class=""> 2095: 	my $self = shift;
</span><span class=""> 2096: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2097: 	if(scalar($self-&gt;{&#39;messages&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2097: Invert condition</b></li>
</ul></details>
<span class=""> 2098: 		my @messages = map { $_-&gt;{&#39;message&#39;} } @{$self-&gt;{&#39;messages&#39;}};
</span><span class=""> 2099: 		return join(&#39;; &#39;, @messages);
</span><span class=""> 2100: 	}
</span><span class=""> 2101: 	return &#39;&#39;;
</span><span class=""> 2102: }
</span><span class=""> 2103: 
</span><span class=""> 2104: =head2 cache($cache)
</span><span class=""> 2105: 
</span><span class=""> 2106: Get/set the internal cache system.
</span><span class=""> 2107: 
</span><span class=""> 2108: Use this rather than pass the cache argument to C&lt;new()&gt; if you see these error messages,
</span><span class=""> 2109: &quot;(in cleanup) Failed to get MD5_CTX pointer&quot;.
</span><span class=""> 2110: It&#39;s some obscure problem that I can&#39;t work out,
</span><span class=""> 2111: but calling this after C&lt;new()&gt; works.
</span><span class=""> 2112: 
</span><span class=""> 2113: =over 4
</span><span class=""> 2114: 
</span><span class=""> 2115: =item $cache
</span><span class=""> 2116: 
</span><span class=""> 2117: Optional cache object.
</span><span class=""> 2118: When not given,
</span><span class=""> 2119: returns the current cache object.
</span><span class=""> 2120: 
</span><span class=""> 2121: =back
</span><span class=""> 2122: 
</span><span class=""> 2123: =cut
</span><span class=""> 2124: 
</span><span class=""> 2125: sub cache
</span><span class=""> 2126: {
</span><span class=""> 2127: 	my $self = shift;
</span><span class=""> 2128: 	my $cache = shift;
</span><span class=""> 2129: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2130: 	if($cache) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2130: Invert condition</b></li>
</ul></details>
<span class=""> 2131: 		croak(ref($self), &#39;:cache($cache) is not an object&#39;) if(!Scalar::Util::blessed($cache));
</span><span class=""> 2132: 		$self-&gt;{&#39;cache&#39;} = $cache;
</span><span class=""> 2133: 	}
</span><span class=""> 2134: 	return $self-&gt;{&#39;cache&#39;};
</span><span class=""> 2135: }
</span><span class=""> 2136: 
</span><span class=""> 2137: =head2 set_logger
</span><span class=""> 2138: 
</span><span class=""> 2139: Sets the class, array, code reference, or file that will be used for logging.
</span><span class=""> 2140: 
</span><span class=""> 2141: Sometimes you don&#39;t know what the logger is until you&#39;ve instantiated the class.
</span><span class=""> 2142: This function fixes the catch-22 situation.
</span><span class=""> 2143: 
</span><span class=""> 2144: =cut
</span><span class=""> 2145: 
</span><span class=""> 2146: sub set_logger
</span><span class=""> 2147: {
</span><span class=""> 2148: 	my $self = shift;
</span><span class=""> 2149: 	my $params = Params::Get::get_params(&#39;logger&#39;, @_);
</span><span class=""> 2150: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2151: 	if(my $logger = $params-&gt;{&#39;logger&#39;}) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2151: Invert condition</b></li>
</ul></details>
<span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2152: 		if(Scalar::Util::blessed($logger)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2152: Invert condition</b></li>
</ul></details>
<span class=""> 2153: 			$self-&gt;{&#39;logger&#39;} = $logger;
</span><span class=""> 2154: 		} else {
</span><span class=""> 2155: 			$self-&gt;{&#39;logger&#39;} = Log::Abstraction-&gt;new($logger);
</span><span class=""> 2156: 		}
</span><span class=""> 2157: 	} else {
</span><span class=""> 2158: 		$self-&gt;{&#39;logger&#39;} = Log::Abstraction-&gt;new();
</span><span class=""> 2159: 	}
</span><span class=""> 2160: 	return $self;
</span><span class=""> 2161: }
</span><span class=""> 2162: 
</span><span class=""> 2163: # Log and remember a message
</span><span class=""> 2164: sub _log
</span><span class=""> 2165: {
</span><span class=""> 2166: 	my ($self, $level, @messages) = @_;
</span><span class=""> 2167: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2168: 	if(scalar(@messages)) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2168: Invert condition</b></li>
</ul></details>
<span class=""> 2169: 		# FIXME: add caller&#39;s function
</span><span class=""> 2170: 		# if(($level eq &#39;warn&#39;) || ($level eq &#39;info&#39;)) {
</span><span class=""> 2171: 			push @{$self-&gt;{&#39;messages&#39;}}, { level =&gt; $level, message =&gt; join(&#39; &#39;, grep defined, @messages) };
</span><span class=""> 2172: 		# }
</span><span class=""> 2173: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2174: 		if(scalar(@messages) &amp;&amp; (my $logger = $self-&gt;{&#39;logger&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2174: Invert condition</b></li>
</ul></details>
<span class=""> 2175: 			$self-&gt;{&#39;logger&#39;}-&gt;$level(join(&#39;&#39;, grep defined, @messages));
</span><span class=""> 2176: 		}
</span><span class=""> 2177: 	}
</span><span class=""> 2178: }
</span><span class=""> 2179: 
</span><span class=""> 2180: sub _debug {
</span><span class=""> 2181: 	my $self = shift;
</span><span class=""> 2182: 	$self-&gt;_log(&#39;debug&#39;, @_);
</span><span class=""> 2183: }
</span><span class=""> 2184: 
</span><span class=""> 2185: sub _info {
</span><span class=""> 2186: 	my $self = shift;
</span><span class=""> 2187: 	$self-&gt;_log(&#39;info&#39;, @_);
</span><span class=""> 2188: }
</span><span class=""> 2189: 
</span><span class=""> 2190: sub _notice {
</span><span class=""> 2191: 	my $self = shift;
</span><span class=""> 2192: 	$self-&gt;_log(&#39;notice&#39;, @_);
</span><span class=""> 2193: }
</span><span class=""> 2194: 
</span><span class=""> 2195: sub _trace {
</span><span class=""> 2196: 	my $self = shift;
</span><span class=""> 2197: 	$self-&gt;_log(&#39;trace&#39;, @_);
</span><span class=""> 2198: }
</span><span class=""> 2199: 
</span><span class=""> 2200: # Emit a warning message somewhere
</span><span class=""> 2201: sub _warn {
</span><span class=""> 2202: 	my $self = shift;
</span><span class=""> 2203: 	my $params = Params::Get::get_params(&#39;warning&#39;, @_);
</span><span class=""> 2204: 
</span><span class=""> 2205: 	$self-&gt;_log(&#39;warn&#39;, $params-&gt;{&#39;warning&#39;});
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2206: 	if(!defined($self-&gt;{&#39;logger&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2206: Invert condition</b></li>
</ul></details>
<span class=""> 2207: 		Carp::carp($params-&gt;{&#39;warning&#39;});
</span><span class=""> 2208: 	}
</span><span class=""> 2209: }
</span><span class=""> 2210: 
</span><span class=""> 2211: # Emit an error message somewhere
</span><span class=""> 2212: sub _error {
</span><span class=""> 2213: 	my $self = shift;
</span><span class=""> 2214: 	my $params = Params::Get::get_params(&#39;warning&#39;, @_);
</span><span class=""> 2215: 
</span><span class=""> 2216: 	$self-&gt;_log(&#39;error&#39;, $params-&gt;{&#39;warning&#39;});
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2217: 	if(!defined($self-&gt;{&#39;logger&#39;})) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2217: Invert condition</b></li>
</ul></details>
<span class=""> 2218: 		Carp::croak($params-&gt;{&#39;warning&#39;});
</span><span class=""> 2219: 	}
</span><span class=""> 2220: }
</span><span class=""> 2221: 
</span><span class=""> 2222: # Ensure all environment variables are sanitized and validated before use.
</span><span class=""> 2223: # Use regular expressions to enforce strict input formats.
</span><span class=""> 2224: sub _get_env
</span><span class=""> 2225: {
</span><span class=""> 2226: 	my ($self, $var) = @_;
</span><span class=""> 2227: 
</span><span class=""> 2228: 	return unless defined $ENV{$var};
</span><span class=""> 2229: 
</span><span class=""> 2230: 	# Strict sanitization: allow alphanumeric and limited special characters
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2231: 	if($ENV{$var} =~ /^[\w\.\-\/:\\]+$/) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2231: Invert condition</b></li>
</ul></details>
<span class=""> 2232: 		return $ENV{$var};
</span><span class=""> 2233: 	}
</span><span class=""> 2234: 	$self-&gt;_warn(&quot;Invalid value in environment variable: $var&quot;);
</span><span class=""> 2235: 
</span><span class=""> 2236: 	return undef;
</span><span class=""> 2237: }
</span><span class=""> 2238: 
</span><span class=""> 2239: =head2 reset
</span><span class=""> 2240: 
</span><span class=""> 2241: Class method to reset the class.
</span><span class=""> 2242: You should do this in an FCGI environment before instantiating,
</span><span class=""> 2243: but nowhere else.
</span><span class=""> 2244: 
</span><span class=""> 2245: =cut
</span><span class=""> 2246: 
</span><span class=""> 2247: sub reset {
</span><span class=""> 2248: 	my $class = shift;
</span><span class=""> 2249: 
</span><span class="killed tooltip" data-tooltip="Mutations here were killed. Tests are effectively covering this logic."> 2250: 	unless($class eq __PACKAGE__) {
</span>
				<details class="mutant-details">
				<summary>Mutants (Total: 1, Killed: 1, Survived: 0)</summary>
				<ul>
			<li><b>COND_INV_2250: Invert condition</b></li>
</ul></details>
<span class=""> 2251: 		carp(&#39;Reset is a class method&#39;);
</span><span class=""> 2252: 		return;
</span><span class=""> 2253: 	}
</span><span class=""> 2254: 
</span><span class=""> 2255: 	$stdin_data = undef;
</span><span class=""> 2256: }
</span><span class=""> 2257: 
</span><span class=""> 2258: sub AUTOLOAD
</span><span class=""> 2259: {
</span><span class=""> 2260: 	our $AUTOLOAD;
</span><span class=""> 2261: 
</span><span class=""> 2262: 	my $self = shift or return;
</span><span class=""> 2263: 
</span><span class=""> 2264: 	return if(!defined($AUTOLOAD));
</span><span class=""> 2265: 
</span><span class=""> 2266: 	# Extract the method name from the AUTOLOAD variable
</span><span class=""> 2267: 	my ($method) = $AUTOLOAD =~ /::(\w+)$/;
</span><span class=""> 2268: 
</span><span class=""> 2269: 	# Skip if called on destruction
</span><span class=""> 2270: 	return if($method eq &#39;DESTROY&#39;);
</span><span class=""> 2271: 
</span><span class=""> 2272: 	Carp::croak(__PACKAGE__, &quot;: Unknown method $method&quot;) if(!ref($self));
</span><span class=""> 2273: 
</span><span class=""> 2274: 	# Allow the AUTOLOAD feature to be disabled
</span><span class=""> 2275: 	Carp::croak(__PACKAGE__, &quot;: Unknown method $method&quot;) if(exists($self-&gt;{&#39;auto_load&#39;}) &amp;&amp; boolean($self-&gt;{&#39;auto_load&#39;})-&gt;isFalse());
</span><span class=""> 2276: 
</span><span class=""> 2277: 	# Ensure the method is called on the correct package object or a subclass
</span><span class=""> 2278: 	return unless((ref($self) eq __PACKAGE__) || (UNIVERSAL::isa((caller)[0], __PACKAGE__)));
</span><span class=""> 2279: 
</span><span class=""> 2280: 	# Validate method name - only allow safe parameter names
</span><span class=""> 2281: 	Carp::croak(__PACKAGE__, &quot;: Invalid method name: $method&quot;) unless $method =~ /^[a-zA-Z_][a-zA-Z0-9_]*$/;
</span><span class=""> 2282: 
</span><span class=""> 2283: 	# Delegate to the param method
</span><span class=""> 2284: 	return $self-&gt;param($method);
</span><span class=""> 2285: }
</span><span class=""> 2286: 
</span><span class=""> 2287: =head1 AUTHOR
</span><span class=""> 2288: 
</span><span class=""> 2289: Nigel Horne, C&lt;&lt; &lt;njh at nigelhorne.com&gt; &gt;&gt;
</span><span class=""> 2290: 
</span><span class=""> 2291: =head1 BUGS
</span><span class=""> 2292: 
</span><span class=""> 2293: is_tablet() only currently detects the iPad and Windows PCs. Android strings
</span><span class=""> 2294: don&#39;t differ between tablets and smartphones.
</span><span class=""> 2295: 
</span><span class=""> 2296: params() returns a ref which means that calling routines can change the hash
</span><span class=""> 2297: for other routines.
</span><span class=""> 2298: Take a local copy before making amendments to the table if you don&#39;t want unexpected
</span><span class=""> 2299: things to happen.
</span><span class=""> 2300: 
</span><span class=""> 2301: =head1 SEE ALSO
</span><span class=""> 2302: 
</span><span class=""> 2303: =over 4
</span><span class=""> 2304: 
</span><span class=""> 2305: =item * L&lt;Test Dashboard|https://nigelhorne.github.io/CGI-Info/coverage/&gt;
</span><span class=""> 2306: 
</span><span class=""> 2307: =item * L&lt;Object::Configure&gt;
</span><span class=""> 2308: 
</span><span class=""> 2309: =item * L&lt;HTTP::BrowserDetect&gt;
</span><span class=""> 2310: 
</span><span class=""> 2311: =item * L&lt;https://github.com/mitchellkrogza/apache-ultimate-bad-bot-blocker&gt;
</span><span class=""> 2312: 
</span><span class=""> 2313: =back
</span><span class=""> 2314: 
</span><span class=""> 2315: =head1 REPOSITORY
</span><span class=""> 2316: 
</span><span class=""> 2317: L&lt;https://github.com/nigelhorne/CGI-Info&gt;
</span><span class=""> 2318: 
</span><span class=""> 2319: =head1 SUPPORT
</span><span class=""> 2320: 
</span><span class=""> 2321: This module is provided as-is without any warranty.
</span><span class=""> 2322: 
</span><span class=""> 2323: Please report any bugs or feature requests to C&lt;bug-cgi-info at rt.cpan.org&gt;,
</span><span class=""> 2324: or through the web interface at
</span><span class=""> 2325: L&lt;http://rt.cpan.org/NoAuth/ReportBug.html?Queue=CGI-Info&gt;.
</span><span class=""> 2326: I will be notified, and then you&#39;ll
</span><span class=""> 2327: automatically be notified of progress on your bug as I make changes.
</span><span class=""> 2328: 
</span><span class=""> 2329: You can find documentation for this module with the perldoc command.
</span><span class=""> 2330: 
</span><span class=""> 2331:     perldoc CGI::Info
</span><span class=""> 2332: 
</span><span class=""> 2333: You can also look for information at:
</span><span class=""> 2334: 
</span><span class=""> 2335: =over 4
</span><span class=""> 2336: 
</span><span class=""> 2337: =item * MetaCPAN
</span><span class=""> 2338: 
</span><span class=""> 2339: L&lt;https://metacpan.org/dist/CGI-Info&gt;
</span><span class=""> 2340: 
</span><span class=""> 2341: =item * RT: CPAN&#39;s request tracker
</span><span class=""> 2342: 
</span><span class=""> 2343: L&lt;https://rt.cpan.org/NoAuth/Bugs.html?Dist=CGI-Info&gt;
</span><span class=""> 2344: 
</span><span class=""> 2345: =item * CPAN Testers&#39; Matrix
</span><span class=""> 2346: 
</span><span class=""> 2347: L&lt;http://matrix.cpantesters.org/?dist=CGI-Info&gt;
</span><span class=""> 2348: 
</span><span class=""> 2349: =item * CPAN Testers Dependencies
</span><span class=""> 2350: 
</span><span class=""> 2351: L&lt;http://deps.cpantesters.org/?module=CGI::Info&gt;
</span><span class=""> 2352: 
</span><span class=""> 2353: =back
</span><span class=""> 2354: 
</span><span class=""> 2355: =head1 LICENCE AND COPYRIGHT
</span><span class=""> 2356: 
</span><span class=""> 2357: Copyright 2010-2026 Nigel Horne.
</span><span class=""> 2358: 
</span><span class=""> 2359: Usage is subject to licence terms.
</span><span class=""> 2360: 
</span><span class=""> 2361: The licence terms of this software are as follows:
</span><span class=""> 2362: 
</span><span class=""> 2363: =over 4
</span><span class=""> 2364: 
</span><span class=""> 2365: =item * Personal single user, single computer use: GPL2
</span><span class=""> 2366: 
</span><span class=""> 2367: =item * All other users (including Commercial, Charity, Educational, Government)
</span><span class=""> 2368:   must apply in writing for a licence for use from Nigel Horne at the
</span><span class=""> 2369:   above e-mail.
</span><span class=""> 2370: 
</span><span class=""> 2371: =back
</span><span class=""> 2372: 
</span><span class=""> 2373: =cut
</span><span class=""> 2374: 
</span><span class=""> 2375: 1;
</span></pre>

<script>
function toggleTheme() {
    const html = document.documentElement;
    const current = html.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    html.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
}

(function() {
    const saved = localStorage.getItem('theme');
    if (saved) {
        document.documentElement.setAttribute('data-theme', saved);
    }
})();
</script>
</body>
</html>
	